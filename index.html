<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOptima - Gesundheitsoptimierung</title>
    <meta name="description" content="Wissenschaftlich fundierte Gesundheitsoptimierung">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            /* Dark Mode Color Palette */
            --primary-50: #0f1419;
            --primary-100: #1a202c;
            --primary-500: #60a5fa;
            --primary-600: #3b82f6;
            --primary-700: #2563eb;
            --primary-900: #1e40af;
            
            --secondary-500: #34d399;
            --secondary-600: #10b981;
            
            --accent-500: #fbbf24;
            --accent-600: #f59e0b;
            
            --neutral-50: #0f0f0f;
            --neutral-100: #1a1a1a;
            --neutral-200: #262626;
            --neutral-300: #404040;
            --neutral-400: #525252;
            --neutral-500: #737373;
            --neutral-600: #a3a3a3;
            --neutral-700: #d4d4d4;
            --neutral-800: #e5e5e5;
            --neutral-900: #f5f5f5;
            
            /* Dark Glassmorphism */
            --glass-bg: rgba(30, 30, 30, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            
            /* Dark Mode Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 40%, #262626 100%);
            min-height: 100vh;
            min-height: 100dvh;
            color: var(--neutral-800);
            font-feature-settings: 'cv11', 'ss01';
            font-variant-numeric: tabular-nums;
            line-height: 1.5;
            /* Mobile optimizations */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Ensure proper stacking context for fixed navbar */
            position: relative;
        }

        #app {
            position: relative;
            min-height: 100vh;
            min-height: 100dvh;
            padding-bottom: 90px;
            backdrop-filter: blur(20px);
            /* Ensure navbar is always visible */
            overflow-x: hidden;
            width: 100%;
        }

        /* Loading Screen - Dark Mode */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 40%, #262626 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100000;
            backdrop-filter: blur(20px);
        }

        .loading-content {
            text-align: center;
            color: white;
            backdrop-filter: blur(10px);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--space-12);
            box-shadow: var(--glass-shadow);
        }

        .logo {
            font-size: 5rem;
            margin-bottom: var(--space-6);
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));
        }

        .loading-content h1 {
            font-size: 2.75rem;
            margin-bottom: var(--space-8);
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { 
                transform: rotate(0deg);
                border-top-color: rgba(255,255,255,0.8);
            }
            50% {
                border-top-color: rgba(255,255,255,0.4);
            }
            100% { 
                transform: rotate(360deg);
                border-top-color: rgba(255,255,255,0.8);
            }
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0) scale(1);
            }
            50% { 
                transform: translateY(-10px) scale(1.05);
            }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Screens - Mobile First */
        .screen {
            display: none;
            padding: var(--space-4);
            padding-bottom: 120px !important; /* Extra space for fixed navbar */
            margin: 0;
            /* Mobile optimizations */
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            min-height: calc(100vh - 90px);
            position: relative !important;
            z-index: 1 !important;
            /* Ensure content stays below navbar */
            max-height: calc(100vh - 90px);
            overflow-y: auto;
        }

        .screen.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* Headers - Mobile Optimized */
        .screen-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            /* Mobile touch optimization */
            min-height: 60px;
        }

        .screen-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        }

        .screen-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-800);
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
            /* Mobile optimization */
            line-height: 1.2;
        }

        .steps-display {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow-md);
        }
        .steps-status {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .steps-status.connected::before { content: '‚úì'; }
        .steps-status.disconnected::before { content: '‚ö†'; }

        .streak-display {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-xl);
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .streak-display::before {
            content: 'üî•';
            font-size: 1.1em;
        }

        /* Content - Mobile First */
        .content {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            /* Single column layout for mobile */
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            box-shadow: var(--shadow-lg);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative !important;
            overflow: hidden;
            /* Mobile touch optimization */
            min-height: 44px;
            width: 100%;
            box-sizing: border-box;
            z-index: 10 !important;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: var(--space-4);
            color: var(--neutral-900);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            letter-spacing: -0.02em;
            line-height: 1.3;
        }

        /* Water Tracking */
        .water-progress {
            text-align: center;
        }

        .water-amount {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2563eb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--space-4);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-500), var(--secondary-600));
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: var(--radius-lg);
        }

        .water-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .btn-water {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            border: none;
            padding: var(--space-4);
            border-radius: var(--radius-xl);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            box-shadow: var(--shadow-sm);
        }

        .btn-water:active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }

        /* Timer - Mobile Optimized */
        .timer-display {
            text-align: center;
            padding: var(--space-6) 0;
        }

        #timer-time {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: var(--space-6);
            font-family: 'Inter', monospace;
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        /* Buttons - Mobile Optimized */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            border: none;
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-xl);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-family: inherit;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* Mobile touch optimization */
            min-height: 48px;
            width: 100%;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: var(--neutral-800);
            border: 1px solid var(--glass-border);
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-xl);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-family: inherit;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
            /* Mobile touch optimization */
            min-height: 48px;
            width: 100%;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-secondary:active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
            color: var(--neutral-900);
        }

                 /* Health Tip - Mobile Optimized */
         .daily-tip-badge {
             background: linear-gradient(135deg, var(--secondary-500), var(--secondary-600));
             color: white;
             padding: var(--space-2) var(--space-4);
             border-radius: var(--radius-xl);
             font-size: 0.875rem;
             font-weight: 600;
             text-align: center;
             margin-bottom: var(--space-3);
             width: fit-content;
             animation: pulse 2s infinite;
             box-shadow: var(--shadow-sm);
         }

         @keyframes pulse {
             0% { transform: scale(1); }
             50% { transform: scale(1.05); }
             100% { transform: scale(1); }
         }

         .tip-container {
             display: flex;
             flex-direction: column;
             gap: var(--space-4);
         }

         .health-tip {
             background: var(--glass-bg);
             border: 1px solid var(--glass-border);
             border-radius: var(--radius-xl);
             padding: var(--space-5);
             font-style: italic;
             color: var(--neutral-800);
             line-height: 1.5;
             font-size: 1rem;
             min-height: 100px;
             display: flex;
             align-items: center;
             backdrop-filter: blur(10px);
             box-shadow: var(--shadow-md);
         }

         .tip-controls {
             display: flex;
             flex-direction: column;
             gap: var(--space-3);
         }

         .tip-counter {
             background: var(--glass-bg);
             padding: var(--space-2) var(--space-4);
             border-radius: var(--radius-xl);
             font-weight: 600;
             color: var(--neutral-800);
             font-size: 0.875rem;
             text-align: center;
             backdrop-filter: blur(10px);
             border: 1px solid var(--glass-border);
         }

         .tip-buttons {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: var(--space-3);
         }

         .btn-tip {
             background: #3b82f6;
             color: white;
             border: none;
             padding: 8px 16px;
             border-radius: 20px;
             font-weight: 500;
             cursor: pointer;
             transition: all 0.2s ease;
             font-size: 0.85rem;
             min-width: 100px;
         }

         .btn-tip:hover:not(:disabled) {
             background: #2563eb;
             transform: translateY(-1px);
         }

         .btn-tip:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }

         .btn-tip:active {
             transform: translateY(0);
         }

         .btn-tip-daily {
             background: #10b981;
         }

         .btn-tip-daily:hover:not(:disabled) {
             background: #059669;
         }

        /* Bottom Navigation - FORCE ALWAYS VISIBLE */
        .bottom-nav {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            top: auto !important;
            background: rgba(20, 20, 20, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
            display: none !important; /* Hidden by default, shown after loading */
            justify-content: space-around !important;
            align-items: center !important;
            padding: var(--space-3) var(--space-2) !important;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15) !important;
            z-index: 2147483647 !important; /* Maximum possible z-index */
            width: 100vw !important;
            height: auto !important;
            min-height: 80px !important;
            /* Mobile safe area */
            padding-bottom: max(var(--space-3), env(safe-area-inset-bottom)) !important;
            /* Force always visible */
            border-radius: 0 !important;
            transform: translateZ(0) !important;
            will-change: transform !important;
            /* Ensure it stays at viewport bottom */
            margin: 0 !important;
            max-width: none !important;
            min-width: 100vw !important;
            /* Force positioning */
            inset: auto 0 0 0 !important;
        }

        /* Show navigation when app is loaded */
        .bottom-nav.loaded {
            display: flex !important;
        }

        /* Ensure all content is below navbar */
        body::after {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: transparent;
            z-index: 2147483646;
            pointer-events: none;
        }

        .nav-btn {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-2);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: var(--radius-lg);
            flex: 1;
            position: relative;
            overflow: hidden;
            /* Mobile touch optimization */
            min-height: 60px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: var(--radius-lg);
        }

        .nav-btn:active::before {
            opacity: 0.1;
        }

        .nav-btn.active::before {
            opacity: 0.15;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn {
            color: var(--neutral-600);
        }

        .nav-btn.active {
            color: var(--primary-500);
        }

        .nav-btn.active .nav-icon {
            transform: scale(1.1);
            filter: drop-shadow(0 2px 4px rgba(14, 165, 233, 0.3));
        }

        .nav-icon {
            font-size: 1.4rem;
            margin-bottom: var(--space-1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
            letter-spacing: 0.025em;
            line-height: 1;
            text-align: center;
        }

                 /* Schedule */
         .schedule-controls {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 10px;
         }

         .schedule-date {
             color: #6b7280;
             font-weight: 500;
         }

        .schedule-timeline {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        .schedule-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .schedule-time {
            width: 80px;
            font-weight: 600;
            color: var(--primary-500);
            font-size: 0.9rem;
        }

        .schedule-activity {
            flex: 1;
            margin-left: 15px;
        }

        .schedule-activity h4 {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--neutral-900);
        }

        .schedule-activity p {
            color: var(--neutral-700);
            font-size: 0.9rem;
        }

                 .focus-phase {
             background: rgba(245, 158, 11, 0.1);
             border-left: 4px solid #f59e0b;
             padding-left: 15px;
             margin-left: -15px;
         }

         /* Schedule Edit Mode */
         .schedule-item.edit-mode {
             background: var(--glass-bg);
             backdrop-filter: var(--glass-blur);
             border: 2px solid var(--glass-border);
             padding: 15px;
             margin-bottom: 15px;
             border-radius: 12px;
         }

         .schedule-edit-controls {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
         }

         .edit-time {
             padding: 8px 12px;
             border: 2px solid var(--glass-border);
             border-radius: 6px;
             font-weight: 600;
             color: var(--primary-500);
             font-size: 0.9rem;
             background: var(--glass-bg);
         }

         .btn-delete {
             background: #dc2626;
             color: white;
             border: none;
             padding: 8px 12px;
             border-radius: 6px;
             cursor: pointer;
         }

         .btn-delete:active {
             background: #b91c1c;
         }

         .schedule-edit-content {
             display: grid;
             gap: 10px;
         }

         .edit-activity {
             padding: 10px;
             border: 2px solid var(--glass-border);
             border-radius: 6px;
             font-weight: 600;
             font-size: 1rem;
             background: var(--glass-bg);
             color: var(--neutral-900);
         }

         .edit-description {
             padding: 10px;
             border: 2px solid var(--glass-border);
             border-radius: 6px;
             resize: vertical;
             min-height: 60px;
             font-family: inherit;
             background: var(--glass-bg);
             color: var(--neutral-900);
         }

         .schedule-options {
             display: flex;
             gap: 20px;
             align-items: center;
         }

         .schedule-options label {
             display: flex;
             align-items: center;
             gap: 8px;
             font-weight: 500;
             cursor: pointer;
             color: var(--neutral-800);
         }

         .schedule-options input[type="checkbox"] {
             width: 16px;
             height: 16px;
         }

         .notification-indicator {
             color: var(--secondary-500);
             font-size: 0.8rem;
             font-weight: 500;
             margin-top: 5px;
         }

        /* Supplements */
        .supplement-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .filter-btn {
            background: #f3f4f6;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: #e5e7eb;
        }

        .filter-btn.active {
            background: #2563eb;
            color: white;
        }

        .supplements-grid {
            display: grid;
            gap: 15px;
        }

        .supplement-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }


        .supplement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .supplement-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--neutral-900);
        }

        .supplement-category {
            background: var(--primary-500);
            color: var(--neutral-50);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .supplement-description {
            color: var(--neutral-700);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .supplement-dosage {
            font-weight: 500;
            color: var(--secondary-500);
            margin-bottom: 10px;
        }

                 .supplement-actions {
             display: flex;
             gap: 10px;
         }

         .supplement-importance {
             font-weight: 600;
             font-size: 0.9rem;
             margin-bottom: 10px;
             padding: 8px 12px;
             border-radius: 8px;
             background: var(--neutral-200);
             color: var(--neutral-800);
         }

         .supplement-evidence {
             font-size: 0.9rem;
             color: var(--neutral-700);
             margin-bottom: 15px;
         }

         /* Priority styling */
         .priority-1 {
             border-left: 4px solid #dc2626;
         }

         .priority-1 .supplement-importance {
             background: rgba(220, 38, 38, 0.1);
             color: #dc2626;
         }

         .priority-2 {
             border-left: 4px solid #ea580c;
         }

         .priority-2 .supplement-importance {
             background: rgba(234, 88, 12, 0.1);
             color: #ea580c;
         }

         .priority-3 {
             border-left: 4px solid #ca8a04;
         }

         .priority-3 .supplement-importance {
             background: rgba(202, 138, 4, 0.1);
             color: #ca8a04;
         }

         .priority-4 {
             border-left: 4px solid #059669;
         }

         .priority-4 .supplement-importance {
             background: rgba(5, 150, 105, 0.1);
             color: #059669;
         }

         .filter-btn.priority {
             font-size: 0.8rem;
             padding: 6px 12px;
         }

        .btn-add {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .btn-add:hover {
            background: #059669;
        }

        .btn-add.added {
            background: #6b7280;
        }

        /* My Supplements Section */
        .my-supplements-list {
            min-height: 60px;
            margin-bottom: 20px;
        }

        .empty-supplements {
            color: var(--neutral-600);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .my-supplement-item {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-supplement-info {
            flex: 1;
        }

        .my-supplement-name {
            font-weight: 600;
            color: var(--neutral-900);
            margin-bottom: 5px;
        }

        .my-supplement-dosage {
            color: var(--neutral-700);
            font-size: 0.9rem;
        }

        .btn-remove {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-remove:active {
            background: #b91c1c;
        }

        /* Progress */
        .progress-tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tab-btn {
            background: #f3f4f6;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            background: #e5e7eb;
        }

        .tab-btn.active {
            background: #2563eb;
            color: white;
        }

        .tab-content {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        .daily-input h3 {
            margin-bottom: 20px;
            color: var(--neutral-900);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--neutral-800);
        }

        .input-group input[type="range"] {
            width: 100%;
            margin-bottom: 8px;
        }

        .input-group input[type="text"],
        .input-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            background: var(--glass-bg);
            color: var(--neutral-900);
        }

        .input-group input[type="text"]:focus,
        .input-group input[type="number"]:focus {
            outline: none;
            border-color: #2563eb;
        }

        /* Profile */
        .profile-form {
            display: grid;
            gap: 15px;
        }

        .bmi-display {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            color: #1e40af;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .goal-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-card:hover {
            border-color: #2563eb;
            background: #f0f9ff;
        }

        .goal-card.active {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .goal-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .goal-title {
            font-weight: 600;
            color: #1f2937;
        }

        .settings-list {
            display: grid;
            gap: 15px;
        }

        .auth-section { margin-top: 0; }
        .auth-hint { font-size: 0.9rem; color: var(--neutral-600); margin-bottom: 1rem; }
        .auth-buttons { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
        .auth-message { margin-top: 0.75rem; font-size: 0.9rem; }
        .auth-message.error { color: #ef4444; }
        .auth-message.success { color: var(--secondary-600); }
        .auth-email, .auth-sync-hint { margin-bottom: 0.5rem; font-size: 0.95rem; }
        .auth-sync-hint { color: var(--neutral-600); font-size: 0.85rem; }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f3f4f6;
        }

                 .setting-item:last-child {
             border-bottom: none;
         }

         /* Additional CSS for dynamic content */
         .weekly-summary {
             background: var(--glass-bg);
             border: 1px solid var(--glass-border);
             border-radius: 12px;
             padding: 20px;
         }

         .weekly-table {
             width: 100%;
             border-collapse: collapse;
             margin: 15px 0;
             font-size: 0.95rem;
         }
         .weekly-table th, .weekly-table td {
             padding: 10px 12px;
             text-align: left;
             border-bottom: 1px solid var(--glass-border);
         }
         .weekly-table th { color: var(--neutral-600); font-weight: 600; }
         .weekly-table td { color: var(--neutral-800); }

         .stat-grid { display: grid; gap: 10px; margin-top: 10px; }
         .stat-item {
             display: flex;
             justify-content: space-between;
             padding: 10px 0;
             border-bottom: 1px solid var(--glass-border);
         }
         .stat-item:last-child { border-bottom: none; }

         .gesamt-stats {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
             gap: 12px;
             margin-bottom: 20px;
         }
         .stat-card {
             background: var(--glass-bg);
             border: 1px solid var(--glass-border);
             border-radius: var(--radius-lg);
             padding: 15px;
             text-align: center;
         }
         .stat-card .stat-value { display: block; font-size: 1.25rem; font-weight: 700; color: var(--primary-500); }
         .stat-card .stat-label { font-size: 0.8rem; color: var(--neutral-600); }
         .insight-list { margin: 15px 0; padding-left: 20px; color: var(--neutral-800); line-height: 1.6; }

         .value-badge, .value-cell {
             display: inline-block;
             padding: 4px 10px;
             border-radius: var(--radius-md);
             font-weight: 600;
             min-width: 28px;
             text-align: center;
         }
         .weekly-table .value-cell { padding: 6px 10px; }
         .weekly-table .no-data { color: var(--neutral-500); }

         .calendar-filter {
             display: flex;
             gap: 8px;
             flex-wrap: wrap;
             margin-bottom: 15px;
         }
         .filter-metric {
             padding: 8px 14px;
             border-radius: var(--radius-lg);
             border: 1px solid var(--glass-border);
             background: var(--glass-bg);
             color: var(--neutral-800);
             font-weight: 500;
             cursor: pointer;
         }
         .filter-metric.active { background: var(--primary-600); color: #fff; border-color: var(--primary-600); }
         .filter-metric:hover:not(.active) { background: var(--neutral-200); }

         .progress-calendar {
             background: var(--glass-bg);
             border: 1px solid var(--glass-border);
             border-radius: var(--radius-xl);
             padding: 12px;
             margin: 0 auto 15px;
             max-width: 280px;
         }
         .calendar-header {
             display: flex;
             align-items: center;
             justify-content: space-between;
             margin-bottom: 8px;
             font-weight: 600;
             font-size: 0.95rem;
             color: var(--neutral-800);
         }
         .cal-nav {
             background: var(--neutral-200);
             border: none;
             padding: 4px 10px;
             border-radius: var(--radius-md);
             cursor: pointer;
             color: var(--neutral-800);
             font-size: 0.9rem;
         }
         .cal-nav:hover { background: var(--neutral-300); }
         .calendar-grid { display: flex; flex-direction: column; gap: 2px; }
         .cal-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; min-height: 26px; }
         .cal-row.cal-header span { font-size: 0.65rem; color: var(--neutral-600); font-weight: 600; text-align: center; }
         .cal-cell {
             height: 26px;
             min-width: 0;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 0.7rem;
             font-weight: 500;
             border-radius: 4px;
         }
         .cal-cell.cal-empty { background: transparent; color: transparent; }
         .cal-legend {
             display: flex;
             align-items: center;
             gap: 6px;
             margin-top: 8px;
             font-size: 0.7rem;
             color: var(--neutral-600);
         }
         .cal-legend span { display: inline-block; width: 12px; height: 12px; border-radius: 3px; }
        .calendar-multi {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }
        .calendar-multi .progress-calendar {
            max-width: none;
            width: 100%;
            margin: 0;
        }
        .calendar-metric-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--neutral-800);
            text-align: center;
        }
        @media (max-width: 1100px) {
            .calendar-multi { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 640px) {
            .calendar-multi { grid-template-columns: 1fr; }
        }

         .insight-item {
             background: var(--glass-bg);
             backdrop-filter: var(--glass-blur);
             border: 1px solid var(--glass-border);
             border-radius: 12px;
             padding: 15px;
             margin-bottom: 15px;
         }

         .insight-item h4 {
             color: var(--primary-500);
             margin-bottom: 8px;
         }

         .insight-item p {
             color: var(--neutral-800);
             line-height: 1.5;
         }

        /* Responsive Design */
        @media (max-width: 768px) {
            .screen {
                padding: 15px;
            }

            .screen-header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .screen-header h1 {
                font-size: 1.5rem;
            }

            #timer-time {
                font-size: 2.5rem;
            }

            .timer-controls {
                flex-direction: column;
                align-items: center;
            }

            .water-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn-water {
                width: 100%;
                max-width: 200px;
            }

            .supplement-filters {
                justify-content: center;
            }

            .progress-tabs {
                justify-content: center;
            }

                         .goals-grid {
                 grid-template-columns: 1fr;
             }

             .schedule-controls {
                 flex-direction: column;
                 align-items: stretch;
                 gap: 10px;
             }

             .schedule-controls button {
                 width: 100%;
                 padding: 12px;
                 font-size: 0.9rem;
             }

             .schedule-options {
                 flex-direction: column;
                 gap: 10px;
                 align-items: flex-start;
             }

             /* Schedule Edit Mode Mobile */
             .schedule-item.edit-mode {
                 padding: 12px;
                 margin-bottom: 12px;
             }

             .schedule-edit-controls {
                 flex-direction: column;
                 gap: 10px;
                 margin-bottom: 12px;
             }

             .edit-time {
                 width: 100%;
                 padding: 12px;
                 font-size: 1rem;
                 text-align: center;
             }

             .btn-delete {
                 width: 100%;
                 padding: 10px;
                 font-size: 0.9rem;
             }

             .edit-activity,
             .edit-description {
                 width: 100%;
                 padding: 12px;
                 font-size: 1rem;
             }

             .edit-description {
                 min-height: 80px;
             }

             .schedule-options {
                 flex-direction: column;
                 gap: 15px;
                 align-items: stretch;
             }

             .schedule-options label {
                 padding: 10px;
                 background: var(--glass-bg);
                 border: 1px solid var(--glass-border);
                 border-radius: 8px;
                 justify-content: center;
             }

             .schedule-options input[type="checkbox"] {
                 width: 20px;
                 height: 20px;
             }

             .tip-controls {
                 flex-direction: column;
                 align-items: stretch;
             }

             .tip-buttons {
                 justify-content: center;
             }

             .btn-tip {
                 flex: 1;
                 min-width: 80px;
             }
         }

        @media (max-width: 480px) {
            .nav-label {
                display: none;
            }

            .nav-btn {
                min-width: 50px;
            }

            .card {
                padding: 15px;
            }

            .loading-content h1 {
                font-size: 2rem;
            }

            .logo {
                font-size: 3rem;
            }

            /* Schedule Edit Mode Small Mobile */
            .schedule-item.edit-mode {
                padding: 10px;
                margin-bottom: 10px;
            }

            .schedule-edit-controls {
                gap: 8px;
                margin-bottom: 10px;
            }

            .edit-time,
            .edit-activity,
            .edit-description,
            .btn-delete {
                padding: 10px;
                font-size: 0.9rem;
            }

            .schedule-options label {
                padding: 8px;
                font-size: 0.9rem;
            }

            .schedule-options input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }

            .schedule-controls {
                gap: 8px;
            }

            .schedule-controls button {
                padding: 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading" class="screen">
            <div class="loading-content">
                <div class="logo">üöÄ</div>
                <h1>LifeOptima</h1>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Navigation -->
        <nav id="bottom-nav" class="bottom-nav hidden">
            <button class="nav-btn active" data-screen="home">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-btn" data-screen="schedule">
                <span class="nav-icon">üïí</span>
                <span class="nav-label">Schedule</span>
            </button>
            <button class="nav-btn" data-screen="supplements">
                <span class="nav-icon">üíä</span>
                <span class="nav-label">Supplements</span>
            </button>
            <button class="nav-btn" data-screen="progress">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Progress</span>
            </button>
            <button class="nav-btn" data-screen="profile">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">Profile</span>
            </button>
        </nav>

        <!-- Home Screen -->
        <div id="home" class="screen hidden">
            <header class="screen-header">
                <h1>üè† Home</h1>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div class="streak-display">
                        <span id="current-streak">0</span> Tage Streak
                    </div>
                    <div class="steps-display">
                        <span id="current-steps">-</span> Schritte
                        <span id="steps-status" class="steps-status" title="Google Fit Status"></span>
                    </div>
                </div>
            </header>
            
            <!-- Gesundheitstipps direkt unter Streak -->
            <div class="card">
                <h2>üí° Gesundheitstipps</h2>
                <div id="daily-tip-badge" class="daily-tip-badge">üìÖ Tipp des Tages</div>
                <div class="tip-container">
                    <div id="daily-tip" class="health-tip">
                        Trinke direkt nach dem Aufwachen 500ml Wasser, um den Stoffwechsel anzukurbeln.
                    </div>
                    <div class="tip-controls">
                        <div class="tip-counter">
                            <span id="tip-current">1</span> / <span id="tip-total">48</span>
                        </div>
                        <div class="tip-buttons">
                            <button id="daily-tip-btn" class="btn-tip btn-tip-daily">üìÖ Heute</button>
                            <button id="random-tip" class="btn-tip">üé≤ Zuf√§llig</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <!-- Water Tracking -->
                <div class="card">
                    <h2>ÔøΩÔøΩ Wasser Tracking</h2>
                    <div class="water-progress">
                        <div class="water-amount">
                            <span id="water-current">0</span> / <span id="water-target">2500</span> ml
                        </div>
                        <div class="progress-bar">
                            <div id="water-progress" class="progress-fill"></div>
                        </div>
                        <div class="water-buttons">
                            <button class="btn-water" data-amount="250">250ml</button>
                            <button class="btn-water" data-amount="500">500ml</button>
                            <button class="btn-water" data-amount="750">750ml</button>
                        </div>
                    </div>
                </div>

                <!-- 90-Min Timer -->
                <div class="card">
                    <h2>‚è±Ô∏è 90-Min Focus Timer</h2>
                    <div class="timer-display">
                        <div id="timer-time">90:00</div>
                        <div class="timer-controls">
                            <button id="timer-start" class="btn-primary">Start</button>
                            <button id="timer-pause" class="btn-secondary hidden">Pause</button>
                            <button id="timer-reset" class="btn-secondary">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Screen -->
        <div id="schedule" class="screen hidden">
            <header class="screen-header">
                <h1>üïí Tagesplan</h1>
                <div class="schedule-date" id="schedule-date"></div>
            </header>
            
            <div class="content">
                <div class="schedule-timeline" id="schedule-timeline">
                    <!-- Timeline wird dynamisch generiert -->
                </div>
                
                <div class="schedule-controls">
                    <button id="edit-schedule" class="btn-secondary">‚úèÔ∏è Bearbeiten</button>
                    <button id="add-schedule-item" class="btn-primary hidden">‚ûï Hinzuf√ºgen</button>
                    <button id="save-schedule" class="btn-primary hidden">üíæ Speichern</button>
                    <button id="reset-schedule" class="btn-secondary hidden">üîÑ Zur√ºcksetzen</button>
                </div>
            </div>
        </div>

        <!-- Supplements Screen -->
        <div id="supplements" class="screen hidden">
            <header class="screen-header">
                <h1>üíä Supplements</h1>
                <div class="supplement-filters">
                    <button class="filter-btn active" data-filter="all">Alle</button>
                    <button class="filter-btn priority" data-filter="priority-1">üî¥ Kritisch</button>
                    <button class="filter-btn priority" data-filter="priority-2">üü† Hoch</button>
                    <button class="filter-btn priority" data-filter="priority-3">üü° Mittel</button>
                    <button class="filter-btn priority" data-filter="priority-4">üü¢ Niedrig</button>
                    <button class="filter-btn" data-filter="cognitive">Kognition</button>
                    <button class="filter-btn" data-filter="performance">Performance</button>
                    <button class="filter-btn" data-filter="recovery">Recovery</button>
                </div>
            </header>
            
            <div class="content">
                <!-- Meine Supplements -->
                <div class="card" id="my-supplements-section">
                    <h2>üìã Meine Supplements</h2>
                    <div id="my-supplements-list" class="my-supplements-list">
                        <p class="empty-supplements">Noch keine Supplements hinzugef√ºgt. W√§hle unten aus der Liste aus.</p>
                    </div>
                    <button id="add-custom-supplement" class="btn-primary">‚ûï Eigenes hinzuf√ºgen</button>
                </div>

                <!-- Alle Supplements -->
                <div class="card">
                    <h2>üîç Alle Supplements</h2>
                    <div id="supplements-list" class="supplements-grid">
                        <!-- Supplements werden dynamisch generiert -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Screen -->
        <div id="progress" class="screen hidden">
            <header class="screen-header">
                <h1>üìä Progress</h1>
                <div class="progress-tabs">
                    <button class="tab-btn active" data-tab="daily">Heute</button>
                    <button class="tab-btn" data-tab="weekly">Woche</button>
                    <button class="tab-btn" data-tab="gesamt">Gesamt</button>
                </div>
            </header>
            
            <div class="content">
                <!-- Daily Tab -->
                <div id="daily-tab" class="tab-content">
                    <div class="daily-input">
                        <h3>Heutiger Status</h3>
                        <div class="input-group">
                            <label>Sport / Bewegung (1-10)</label>
                            <input type="range" id="sport-level" min="1" max="10" value="5">
                            <span id="sport-value" class="value-badge">5</span>
                        </div>
                        <div class="input-group">
                            <label>Energie Level (1-10)</label>
                            <input type="range" id="energy-level" min="1" max="10" value="5">
                            <span id="energy-value" class="value-badge">5</span>
                        </div>
                        <div class="input-group">
                            <label>Schlafqualit√§t (1-10)</label>
                            <input type="range" id="sleep-quality" min="1" max="10" value="5">
                            <span id="sleep-value" class="value-badge">5</span>
                        </div>
                        <div class="input-group">
                            <label>Stimmung (1-10)</label>
                            <input type="range" id="mood-level" min="1" max="10" value="5">
                            <span id="mood-value" class="value-badge">5</span>
                        </div>
                    </div>
                </div>

                <!-- Weekly Tab -->
                <div id="weekly-tab" class="tab-content hidden">
                    <div class="weekly-stats">
                        <h3>Wochenstatistiken</h3>
                        <div id="weekly-charts"></div>
                    </div>
                </div>

                <!-- Gesamt Tab -->
                <div id="gesamt-tab" class="tab-content hidden">
                    <div class="progress-overview">
                        <h3>Gesamt√ºbersicht</h3>
                        <div id="gesamt-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile" class="screen hidden">
            <header class="screen-header">
                <h1>üë§ Profile</h1>
            </header>
            
            <div class="content">
                <!-- Personal Data -->
                <div class="card">
                    <h2>Pers√∂nliche Daten</h2>
                    <div class="profile-form">
                        <div class="input-group">
                            <label>Name</label>
                            <input type="text" id="user-name" placeholder="Dein Name">
                        </div>
                        <div class="input-group">
                            <label>Alter</label>
                            <input type="number" id="user-age" placeholder="25">
                        </div>
                        <div class="input-group">
                            <label>Gr√∂√üe (cm)</label>
                            <input type="number" id="user-height" placeholder="175">
                        </div>
                        <div class="input-group">
                            <label>Gewicht (kg)</label>
                            <input type="number" id="user-weight" placeholder="70">
                        </div>
                        <div class="bmi-display">
                            <strong>BMI: <span id="bmi-value">-</span></strong>
                        </div>
                    </div>
                </div>

                <!-- Goals -->
                <div class="card">
                    <h2>Ziele</h2>
                    <div id="goals-list" class="goals-grid">
                        <!-- Goals werden dynamisch generiert -->
                    </div>
                </div>

                <!-- Konto / Anmeldung -->
                <div class="card" id="auth-card">
                    <h2>üîê Konto</h2>
                    <div id="auth-logged-out" class="auth-section">
                        <p class="auth-hint">Melde dich an, damit deine Daten (Profil, Fortschritt, Tagesplan) in der Cloud gespeichert und auf allen Ger√§ten verf√ºgbar sind.</p>
                        <div class="input-group">
                            <label>E-Mail</label>
                            <input type="email" id="auth-email" placeholder="deine@email.de" autocomplete="email">
                        </div>
                        <div class="input-group">
                            <label>Passwort</label>
                            <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                        </div>
                        <div class="auth-buttons">
                            <button type="button" id="auth-login" class="btn-primary">Anmelden</button>
                            <button type="button" id="auth-register" class="btn-secondary">Konto erstellen</button>
                        </div>
                        <p id="auth-message" class="auth-message hidden"></p>
                    </div>
                    <div id="auth-logged-in" class="auth-section hidden">
                        <p class="auth-email"><strong>Angemeldet als:</strong> <span id="auth-email-display"></span></p>
                        <p class="auth-sync-hint">Daten werden automatisch mit dem Server synchronisiert.</p>
                        <button type="button" id="auth-logout" class="btn-secondary">Abmelden</button>
                    </div>
                </div>

                <!-- Google Fit Integration -->
                <div class="card" id="google-fit-card">
                    <h2>üëü Google Fit</h2>
                    <div id="google-fit-disconnected" class="auth-section">
                        <p class="auth-hint">Verbinde Google Fit, um deine Schrittzahl automatisch zu synchronisieren. Funktioniert auch mit Samsung Health, wenn du Samsung Health ‚Üí Google Fit Sync aktiviert hast.</p>
                        <button type="button" id="google-fit-connect" class="btn-primary">üîó Google Fit verbinden</button>
                        <p id="google-fit-message" class="auth-message hidden"></p>
                    </div>
                    <div id="google-fit-connected" class="auth-section hidden">
                        <p class="auth-email"><strong>Verbunden mit Google Fit</strong></p>
                        <p class="auth-sync-hint">Schrittzahl wird automatisch synchronisiert.</p>
                        <button type="button" id="google-fit-disconnect" class="btn-secondary">Verbindung trennen</button>
                        <button type="button" id="google-fit-refresh" class="btn-secondary" style="margin-top: 0.5rem;">üîÑ Aktualisieren</button>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card">
                    <h2>Einstellungen</h2>
                    <div class="settings-list">
                        <div class="setting-item">
                            <label>Benachrichtigungen</label>
                            <input type="checkbox" id="notifications-enabled" checked>
                        </div>
                        <button id="export-data" class="btn-secondary">Daten exportieren</button>
                        <button id="install-app" class="btn-primary hidden">App installieren</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend-URL: lokal = localhost:4000, Netlify = gleiche Origin (API via Functions)
        const BACKEND_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:4000'
            : window.location.origin;

        // App State
        const AppState = {
            currentScreen: 'loading',
            waterIntake: 0,
            waterTarget: 2500,
            currentStreak: 0,
            currentSteps: 0,
            googleFitConnected: false,
            timerTime: 90 * 60, // 90 minutes in seconds
            timerInterval: null,
            timerRunning: false,
            timerStartTime: null,
            userData: {
                name: '',
                age: 25,
                height: 175,
                weight: 70,
                goals: []
            },
            dailyData: {
                energy: 5,
                sleep: 5,
                mood: 5,
                sport: 5
            },
            supplements: [],
            mySupplements: [],
            customSupplements: [],
            notifications: true,
            customSchedule: null,
            scheduleEditMode: false,
            scheduleNotifications: {},
            currentTipIndex: 0,
            supplementNotifications: {}
        };
        let dailyProgressSaveTimeout = null;

        // Scientific data
        const SUPPLEMENTS_DATA = [
            {
                name: 'Vitamin D3',
                category: 'recovery',
                description: 'Unterst√ºtzt Immunsystem und Knochengesundheit. Besonders wichtig bei wenig Sonnenlicht.',
                dosage: '2000-4000 IU t√§glich',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 1,
                importance: 'üî¥ KRITISCH - 90% der Menschen haben Mangel',
                bestTime: 'morgens mit fetthaltiger Mahlzeit'
            },
            {
                name: 'Omega-3 (EPA/DHA)',
                category: 'cognitive',
                description: 'EPA/DHA f√ºr Gehirnfunktion und Herz-Kreislauf-Gesundheit. Reduziert Entz√ºndungen.',
                dosage: '1000-2000mg EPA/DHA t√§glich',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 1,
                importance: 'üî¥ KRITISCH - Essentiell f√ºr Gehirn & Herz',
                bestTime: 'zu einer Hauptmahlzeit mit Fett'
            },
            {
                name: 'Magnesium',
                category: 'recovery',
                description: 'F√ºr Muskelentspannung, Schlafqualit√§t und √ºber 300 enzymatische Reaktionen.',
                dosage: '200-400mg vor dem Schlafengehen',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 1,
                importance: 'üî¥ KRITISCH - 70% haben Mangel',
                bestTime: 'abends, vor dem Schlafen'
            },
            {
                name: 'Kreatin Monohydrat',
                category: 'performance',
                description: 'Steigert k√∂rperliche Leistung und unterst√ºtzt Muskelmasse bei kurzen, intensiven Aktivit√§ten.',
                dosage: '3-5g t√§glich',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 2,
                importance: 'üü† HOCH - Beste Performance-Erg√§nzung',
                bestTime: 'beliebig, aber t√§glich (z.B. morgens)'
            },
            {
                name: 'Vitamin B12',
                category: 'cognitive',
                description: 'Essentiell f√ºr Energiestoffwechsel und Nervenfunktion. Besonders wichtig bei veganer Ern√§hrung.',
                dosage: '250-1000mcg t√§glich',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 2,
                importance: 'üü† HOCH - Kritisch bei veganer Ern√§hrung',
                bestTime: 'morgens, n√ºchtern oder mit Fr√ºhst√ºck'
            },
            {
                name: 'Zink',
                category: 'recovery',
                description: 'Unterst√ºtzt Immunsystem, Wundheilung und Hormonproduktion. Wichtig f√ºr Testosteron.',
                dosage: '8-11mg t√§glich mit Nahrung',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 2,
                importance: 'üü† HOCH - Immunsystem & Hormone',
                bestTime: 'abends, nicht mit Eisen oder Calcium'
            },
            {
                name: 'Vitamin K2 (MK-7)',
                category: 'recovery',
                description: 'Arbeitet synergistisch mit Vitamin D3 f√ºr Knochengesundheit und Herzschutz.',
                dosage: '100-200mcg t√§glich',
                evidence: 'Gut evidenzbasiert',
                priority: 2,
                importance: 'üü† HOCH - Synergistisch mit Vitamin D3',
                bestTime: 'mit Vitamin D3, morgens oder mittags'
            },
            {
                name: 'Ashwagandha',
                category: 'cognitive',
                description: 'Adaptogen zur Stressreduktion und Verbesserung der Schlafqualit√§t.',
                dosage: '300-600mg t√§glich',
                evidence: 'Gut evidenzbasiert',
                priority: 3,
                importance: 'üü° MITTEL - Stressmanagement',
                bestTime: 'abends, vor dem Schlafen'
            },
            {
                name: 'Rhodiola Rosea',
                category: 'performance',
                description: 'Adaptogen zur Verbesserung der mentalen Leistungsf√§higkeit und Stressresistenz.',
                dosage: '200-400mg am Morgen',
                evidence: 'Moderat evidenzbasiert',
                priority: 3,
                importance: 'üü° MITTEL - Mentale Performance',
                bestTime: 'morgens, n√ºchtern oder mit Fr√ºhst√ºck'
            },
            {
                name: 'Curcumin (mit Piperin)',
                category: 'recovery',
                description: 'Potentes Antioxidans mit entz√ºndungshemmenden Eigenschaften f√ºr Gelenke und Regeneration.',
                dosage: '500-1000mg t√§glich mit Piperin',
                evidence: 'Gut evidenzbasiert',
                priority: 3,
                importance: 'üü° MITTEL - Entz√ºndungshemmung',
                bestTime: 'zu einer fetthaltigen Mahlzeit'
            },
            {
                name: 'Probiotika',
                category: 'recovery',
                description: 'Unterst√ºtzt Darmgesundheit, Immunsystem und kann Stimmung positiv beeinflussen.',
                dosage: '10-50 Milliarden CFU t√§glich',
                evidence: 'Gut evidenzbasiert',
                priority: 3,
                importance: 'üü° MITTEL - Darmgesundheit',
                bestTime: 'morgens, n√ºchtern oder 30 Min vor dem Essen'
            },
            {
                name: 'Melatonin',
                category: 'recovery',
                description: 'Nat√ºrliches Schlafhormon zur Verbesserung der Schlafqualit√§t und Einschlafzeit.',
                dosage: '0.5-3mg 30 Min vor dem Schlafengehen',
                evidence: 'Hochgradig evidenzbasiert',
                priority: 3,
                importance: 'üü° MITTEL - Nur bei Schlafproblemen',
                bestTime: '30 Min vor dem Schlafen'
            },
            {
                name: 'L-Theanin',
                category: 'cognitive',
                description: 'Aminos√§ure f√ºr Entspannung ohne M√ºdigkeit. Synergistisch mit Koffein.',
                dosage: '100-200mg bei Bedarf',
                evidence: 'Moderat evidenzbasiert',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Entspannung & Fokus',
                bestTime: 'bei Bedarf, mit Koffein morgens/mittags'
            },
            {
                name: 'Alpha-GPC',
                category: 'cognitive',
                description: 'Cholin-Quelle f√ºr Gehirnfunktion und Acetylcholin-Produktion.',
                dosage: '300-600mg t√§glich',
                evidence: 'Moderat evidenzbasiert',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Kognitive Leistung',
                bestTime: 'morgens oder vor geistiger Leistung'
            },
            {
                name: "Lion's Mane",
                category: 'cognitive',
                description: 'Heilpilz zur Unterst√ºtzung der Neurogenese und kognitiven Funktion.',
                dosage: '500-1000mg t√§glich',
                evidence: 'Moderat evidenzbasiert',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Neuroplastizit√§t',
                bestTime: 'morgens oder mittags'
            },
            {
                name: 'Coenzym Q10',
                category: 'performance',
                description: 'Wichtig f√ºr Zellatmung und Herzgesundheit. Besonders relevant ab 40+.',
                dosage: '100-200mg t√§glich mit Fett',
                evidence: 'Gut evidenzbasiert',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Ab 40+ Jahren',
                bestTime: 'zu einer fetthaltigen Mahlzeit'
            },
            {
                name: 'Kollagen',
                category: 'recovery',
                description: 'Protein f√ºr Haut, Gelenke und Bindegewebe. Besonders f√ºr Sportler.',
                dosage: '10-20g t√§glich',
                evidence: 'Moderat evidenzbasiert',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Gelenke & Haut',
                bestTime: 'morgens oder nach dem Training'
            },
            {
                name: 'Berberin',
                category: 'performance',
                description: 'Nat√ºrlicher Blutzuckerregulator mit √§hnlicher Wirkung wie Metformin.',
                dosage: '500mg 2-3x t√§glich vor Mahlzeiten',
                evidence: 'Gut evidenzbasiert',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Blutzuckermanagement',
                bestTime: 'vor den Hauptmahlzeiten'
            },
            {
                name: 'NAD+ Booster (NMN/NR)',
                category: 'recovery',
                description: 'Unterst√ºtzt zellul√§re Energieproduktion und Anti-Aging-Prozesse.',
                dosage: '250-500mg t√§glich',
                evidence: 'Experimentell',
                priority: 4,
                importance: 'üü¢ NIEDRIG - Experimentell/Teuer',
                bestTime: 'morgens, n√ºchtern'
            }
        ];

        const SCHEDULE_DATA = [
            { time: '06:00', activity: 'Aufwachen', description: 'Nat√ºrliches Erwachen ohne Snooze', phase: 'morning' },
            { time: '06:15', activity: 'Morgendliche Routine', description: '500ml Wasser, 5 Min Meditation', phase: 'morning' },
            { time: '07:00', activity: 'Bewegung', description: '20-30 Min Sport oder Spaziergang', phase: 'morning' },
            { time: '08:00', activity: 'Fr√ºhst√ºck', description: 'Proteinreich mit gesunden Fetten', phase: 'morning' },
            { time: '09:00', activity: 'Fokusphase 1', description: 'Schwierigste Aufgaben zuerst', phase: 'focus', focus: true },
            { time: '10:30', activity: 'Pause', description: '15 Min Pause, Wasser trinken', phase: 'break' },
            { time: '10:45', activity: 'Fokusphase 1 (Fortsetzung)', description: 'Deep Work fortsetzen', phase: 'focus', focus: true },
            { time: '12:00', activity: 'Mittagessen', description: 'Ausgewogene Mahlzeit', phase: 'lunch' },
            { time: '13:00', activity: 'Mittagspause', description: '30 Min entspannen oder spazieren', phase: 'break' },
            { time: '13:30', activity: 'Fokusphase 2', description: 'Kreative Arbeiten', phase: 'focus', focus: true },
            { time: '15:00', activity: 'Pause', description: '15 Min Pause, gesunder Snack', phase: 'break' },
            { time: '15:15', activity: 'Fokusphase 2 (Fortsetzung)', description: 'Projekte voranbringen', phase: 'focus', focus: true },
            { time: '16:30', activity: 'Fokusphase 3', description: 'Administrative Aufgaben', phase: 'focus', focus: true },
            { time: '18:00', activity: 'Arbeitsende', description: 'Klarer Schnitt zwischen Arbeit und Freizeit', phase: 'evening' },
            { time: '19:00', activity: 'Abendessen', description: 'Leichte, fr√ºhe Mahlzeit', phase: 'evening' },
            { time: '20:00', activity: 'Entspannung', description: 'Hobbys, soziale Zeit, Entspannung', phase: 'evening' },
            { time: '21:00', activity: 'Abendroutine', description: 'Bildschirme reduzieren, entspannen', phase: 'evening' },
            { time: '22:00', activity: 'Schlafen', description: 'F√ºr optimale Regeneration', phase: 'sleep' }
        ];

        const HEALTH_TIPS = [
            // Hydration & Stoffwechsel
            'Trinke direkt nach dem Aufwachen 500ml Wasser, um den Stoffwechsel anzukurbeln.',
            'F√ºge eine Prise Himalaya-Salz zu deinem Morgenwasser hinzu f√ºr bessere Hydration.',
            'Trinke 30 Minuten vor jeder Mahlzeit ein Glas Wasser f√ºr bessere Verdauung.',
            'Kaltes Wasser (15-17¬∞C) kann den Stoffwechsel um bis zu 30% f√ºr 1 Stunde steigern.',
            
            // Circadianer Rhythmus & Schlaf
            'Gehe t√§glich mindestens 20 Minuten ins Tageslicht f√ºr bessere Schlafqualit√§t.',
            'Vermeide Koffein 8 Stunden vor dem Schlafengehen f√ºr tieferen Schlaf.',
            'Reduziere blaues Licht 2 Stunden vor dem Schlafengehen.',
            'Halte dein Schlafzimmer zwischen 16-19¬∞C f√ºr optimale Schlafqualit√§t.',
            'Verwende eine Schlafmaske und Ohrst√∂psel f√ºr tieferen Schlaf.',
            'Stehe jeden Tag zur gleichen Zeit auf, auch am Wochenende.',
            
            // Fokus & Produktivit√§t  
            'Nutze die ersten 90 Minuten nach dem Aufwachen f√ºr deine wichtigsten Aufgaben.',
            'Mache alle 90 Minuten eine 15-min√ºtige Pause f√ºr optimale Konzentration.',
            'Vermeide Multitasking - fokussiere dich auf eine Aufgabe zur Zeit.',
            'Nutze die Pomodoro-Technik: 25 Min arbeiten, 5 Min Pause.',
            'Schalte Benachrichtigungen w√§hrend Fokuszeiten komplett aus.',
            
            // Ern√§hrung & Timing
            'Iss deine letzte Mahlzeit 3 Stunden vor dem Schlafengehen.',
            'Praktiziere intermittierendes Fasten mit einem 16:8 Fenster.',
            'Iss binnen 1 Stunde nach dem Aufwachen etwas Protein (20-30g).',
            'Kombiniere Kohlenhydrate immer mit Protein oder gesunden Fetten.',
            'Kaue jeden Bissen mindestens 20 Mal f√ºr bessere Verdauung.',
            
            // Bewegung & Erholung
            'Mache nach jeder Mahlzeit einen 10-min√ºtigen Spaziergang.',
            'Integriere t√§glich mindestens 7 Minuten Bewegung - schon das hilft!',
            'Praktiziere t√§glich 5-10 Minuten Meditation oder Atem√ºbungen.',
            'Nimm t√§glich 10 tiefe Atemz√ºge (4 Sekunden ein, 6 Sekunden aus).',
            'Stehe jede Stunde f√ºr mindestens 2 Minuten auf.',
            
            // Hormonoptimierung
            'Vermeide warme Duschen am Morgen - kalte Duschen aktivieren Noradrenalin.',
            'Exponiere dich t√§glich 2-3 Minuten extremer K√§lte (kalte Dusche).',
            'Praktiziere Sauna oder hei√üe B√§der 3-4x pro Woche f√ºr Wachstumshormon.',
            'Iss Zink-reiche Lebensmittel f√ºr optimale Testosteronproduktion.',
            
            // Stressmanagement
            'F√ºhre ein Dankbarkeitstagebuch - schreibe t√§glich 3 Dinge auf.',
            'Praktiziere die 4-7-8 Atemtechnik bei Stress (4 ein, 7 halten, 8 aus).',
            'Verbringe t√§glich mindestens 10 Minuten in der Natur.',
            'Lache t√§glich - es reduziert Cortisol und st√§rkt das Immunsystem.',
            
            // Soziale Verbindungen
            'F√ºhre t√§glich mindestens ein bedeutungsvolles Gespr√§ch.',
            'Umarme Menschen t√§glich - Oxytocin reduziert Stress.',
            'Verbringe Zeit mit Menschen, die dich inspirieren und unterst√ºtzen.',
            
            // Technologie & Digital 
            'Lege das Handy 1 Stunde vor dem Schlafen weg.',
            'Verwende Apps zur √úberwachung deiner Bildschirmzeit.',
            'Praktiziere t√§glich 1 Stunde "Digital Detox".',
            
            // Supplements & Mikron√§hrstoffe
            'Nimm Vitamin D3 am Morgen mit Fett f√ºr optimale Absorption.',
            'Kombiniere Magnesium mit Glycin am Abend f√ºr besseren Schlaf.',
            'Iss t√§glich eine Handvoll N√ºsse f√ºr gesunde Omega-3-Fetts√§uren.',
            
            // Mentale Optimierung
            'Visualisiere t√§glich 5 Minuten deine Ziele so detailliert wie m√∂glich.',
            'Lerne t√§glich etwas Neues - auch nur 10 Minuten f√∂rdern Neuroplastizit√§t.',
            'Setze dir t√§glich 1-3 klare, messbare Priorit√§ten.',
            'Reflektiere abends 5 Minuten √ºber den Tag und plane den n√§chsten.',
            
            // Umgebungsoptimierung
            'Halte deinen Arbeitsplatz sauber und minimalistisch.',
            'Verwende Pflanzen zur Verbesserung der Luftqualit√§t.',
            'Optimiere die Beleuchtung - helles Licht am Tag, warmes am Abend.',
            'Kontrolliere die Luftfeuchtigkeit (40-60%) f√ºr optimale Gesundheit.'
        ];

        const GOALS_DATA = [
            { id: 'water', icon: 'üíß', title: 'Ausreichend trinken', description: '2.5L Wasser t√§glich' },
            { id: 'sleep', icon: 'üò¥', title: 'Guter Schlaf', description: '7-9 Stunden Schlaf' },
            { id: 'exercise', icon: 'üèÉ', title: 'T√§glich bewegen', description: 'Mindestens 30 Min' },
            { id: 'nutrition', icon: 'ü•ó', title: 'Gesunde Ern√§hrung', description: 'Ausgewogene Mahlzeiten' },
            { id: 'stress', icon: 'üßò', title: 'Stress reduzieren', description: 'Entspannungstechniken' },
            { id: 'focus', icon: 'üéØ', title: 'Fokus verbessern', description: '90-Min Deep Work' },
            { id: 'energy', icon: '‚ö°', title: 'Mehr Energie', description: 'Optimierte Tagesroutine' },
            { id: 'balance', icon: '‚öñÔ∏è', title: 'Work-Life-Balance', description: 'Ausgewogener Alltag' }
        ];

        // ---------- Auth & Cloud-Sync ----------
        const AUTH_TOKEN_KEY = 'lifeOptima_token';
        const AUTH_USER_KEY = 'lifeOptima_user';
        let syncToServerTimeout = null;

        function getAuthToken() { return localStorage.getItem(AUTH_TOKEN_KEY); }
        function getAuthUser() { try { return JSON.parse(localStorage.getItem(AUTH_USER_KEY) || 'null'); } catch { return null; } }
        function setAuth(token, user) {
            localStorage.setItem(AUTH_TOKEN_KEY, token);
            localStorage.setItem(AUTH_USER_KEY, JSON.stringify(user || {}));
            updateAuthUI();
        }
        function clearAuth() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            localStorage.removeItem(AUTH_USER_KEY);
            updateAuthUI();
        }

        function updateAuthUI() {
            const loggedIn = !!getAuthToken();
            const authOut = document.getElementById('auth-logged-out');
            const authIn = document.getElementById('auth-logged-in');
            const emailDisplay = document.getElementById('auth-email-display');
            if (authOut && authIn) {
                if (loggedIn) {
                    authOut.classList.add('hidden');
                    authIn.classList.remove('hidden');
                    const user = getAuthUser();
                    if (emailDisplay) emailDisplay.textContent = user?.email || '';
                } else {
                    authOut.classList.remove('hidden');
                    authIn.classList.add('hidden');
                    if (emailDisplay) emailDisplay.textContent = '';
                }
            }
            const msg = document.getElementById('auth-message');
            if (msg) { msg.classList.add('hidden'); msg.textContent = ''; }
        }

        function showAuthMessage(text, isError) {
            const msg = document.getElementById('auth-message');
            if (!msg) return;
            msg.textContent = text;
            msg.classList.remove('hidden', 'error', 'success');
            msg.classList.add(isError ? 'error' : 'success');
        }

        async function fetchUserData() {
            const token = getAuthToken();
            if (!token) return;
            try {
                const res = await fetch(BACKEND_URL + '/api/me/data', {
                    headers: { Authorization: 'Bearer ' + token }
                });
                if (!res.ok) { if (res.status === 401) clearAuth(); return; }
                const data = await res.json();
                if (data.appState && typeof data.appState === 'object') {
                    Object.assign(AppState, data.appState);
                    if (AppState.dailyData && !AppState.dailyData.date) {
                        const today = new Date().toISOString().split('T')[0];
                        AppState.dailyData = { ...AppState.dailyData, date: today };
                    }
                }
                if (Array.isArray(data.dailyHistory)) {
                    localStorage.setItem('dailyHistory', JSON.stringify(data.dailyHistory));
                    const today = new Date().toISOString().split('T')[0];
                    const todayEntry = data.dailyHistory.find(d => d.date === today);
                    if (todayEntry) {
                        AppState.dailyData = { energy: todayEntry.energy ?? 5, sleep: todayEntry.sleep ?? 5, mood: todayEntry.mood ?? 5, sport: todayEntry.sport ?? 5, date: today };
                        if (document.getElementById('energy-level')) updateDailyInputs();
                    }
                }
            } catch (err) {
                console.error('fetchUserData:', err);
            }
        }

        function syncToServer() {
            const token = getAuthToken();
            if (!token) return;
            const appState = { ...AppState };
            delete appState.timerInterval;
            const dailyHistory = JSON.parse(localStorage.getItem('dailyHistory') || '[]');
            fetch(BACKEND_URL + '/api/me/data', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                body: JSON.stringify({ appState, dailyHistory })
            }).catch(err => console.error('syncToServer:', err));
        }

        function syncToServerDebounced() {
            if (syncToServerTimeout) clearTimeout(syncToServerTimeout);
            syncToServerTimeout = setTimeout(syncToServer, 1500);
        }

        async function doLogin() {
            const email = document.getElementById('auth-email')?.value?.trim();
            const password = document.getElementById('auth-password')?.value;
            if (!email || !password) { showAuthMessage('E-Mail und Passwort eingeben.', true); return; }
            showAuthMessage('Anmeldung ‚Ä¶', false);
            try {
                const res = await fetch(BACKEND_URL + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const text = await res.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) {}
                if (!res.ok) {
                    showAuthMessage(data.error || 'Anmeldung fehlgeschlagen (Server: ' + res.status + ')', true);
                    return;
                }
                setAuth(data.token, data.user);
                await fetchUserData();
                showAuthMessage('Angemeldet. Daten geladen.', false);
                syncAppStateToProfileForm();
                await checkGoogleFitStatus();
                updateStepsDisplay();
                renderGoals(); updateWaterDisplay(); updateBMI(); updateDailyInputs(); renderSchedule(); renderMySupplements();
            } catch (err) {
                console.error('Login error:', err);
                showAuthMessage('Netzwerkfehler. Backend erreichbar? ' + (err.message || ''), true);
            }
        }

        async function doRegister() {
            const email = document.getElementById('auth-email')?.value?.trim();
            const password = document.getElementById('auth-password')?.value;
            if (!email || !password) { showAuthMessage('E-Mail und Passwort eingeben.', true); return; }
            if (password.length < 6) { showAuthMessage('Passwort mindestens 6 Zeichen.', true); return; }
            showAuthMessage('Konto wird erstellt ‚Ä¶', false);
            try {
                const res = await fetch(BACKEND_URL + '/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const text = await res.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) {}
                if (!res.ok) { showAuthMessage(data.error || 'Registrierung fehlgeschlagen (Server: ' + res.status + ')', true); return; }
                setAuth(data.token, data.user);
                syncToServer();
                showAuthMessage('Konto erstellt. Lokale Daten werden hochgeladen.', false);
            } catch (err) {
                console.error('Register error:', err);
                showAuthMessage('Netzwerkfehler. Backend erreichbar? ' + (err.message || ''), true);
            }
        }

        function doLogout() {
            clearAuth();
            document.getElementById('auth-email').value = '';
            document.getElementById('auth-password').value = '';
            AppState.googleFitConnected = false;
            updateGoogleFitUI();
        }

        // ---------- Google Fit Integration ----------
        function updateGoogleFitUI() {
            const connected = AppState.googleFitConnected;
            const disconnectedEl = document.getElementById('google-fit-disconnected');
            const connectedEl = document.getElementById('google-fit-connected');
            if (disconnectedEl && connectedEl) {
                if (connected) {
                    disconnectedEl.classList.add('hidden');
                    connectedEl.classList.remove('hidden');
                } else {
                    disconnectedEl.classList.remove('hidden');
                    connectedEl.classList.add('hidden');
                }
            }
            const statusEl = document.getElementById('steps-status');
            if (statusEl) {
                statusEl.className = 'steps-status ' + (connected ? 'connected' : 'disconnected');
            }
        }

        async function checkGoogleFitStatus() {
            const token = getAuthToken();
            if (!token) return;
            try {
                const res = await fetch(BACKEND_URL + '/api/google-fit/status', {
                    headers: { Authorization: 'Bearer ' + token }
                });
                if (res.ok) {
                    const data = await res.json();
                    AppState.googleFitConnected = data.connected;
                    updateGoogleFitUI();
                    if (data.connected) {
                        loadSteps();
                    }
                }
            } catch (err) {
                console.error('checkGoogleFitStatus:', err);
            }
        }

        async function connectGoogleFit() {
            const token = getAuthToken();
            if (!token) {
                showGoogleFitMessage('Bitte zuerst anmelden.', true);
                return;
            }
            try {
                const res = await fetch(BACKEND_URL + '/api/google-fit/auth', {
                    headers: { Authorization: 'Bearer ' + token }
                });
                const text = await res.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) { /* Server antwortet nicht mit JSON */ }
                if (!res.ok) {
                    showGoogleFitMessage(data.error || 'Server-Fehler: ' + res.status, true);
                    return;
                }
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else if (data.error) {
                    showGoogleFitMessage(data.error, true);
                } else {
                    showGoogleFitMessage('Google Fit nicht konfiguriert. GOOGLE_CLIENT_ID in .env setzen.', true);
                }
            } catch (err) {
                console.error('Google Fit connect:', err);
                showGoogleFitMessage('Netzwerkfehler. Backend l√§uft? ' + err.message, true);
            }
        }

        async function disconnectGoogleFit() {
            const token = getAuthToken();
            if (!token) return;
            try {
                const res = await fetch(BACKEND_URL + '/api/google-fit/disconnect', {
                    method: 'DELETE',
                    headers: { Authorization: 'Bearer ' + token }
                });
                if (res.ok) {
                    AppState.googleFitConnected = false;
                    AppState.currentSteps = 0;
                    updateGoogleFitUI();
                    updateStepsDisplay();
                    showGoogleFitMessage('Google Fit getrennt.', false);
                }
            } catch (err) {
                showGoogleFitMessage('Fehler beim Trennen.', true);
            }
        }

        async function loadSteps() {
            const token = getAuthToken();
            if (!token || !AppState.googleFitConnected) return;
            try {
                const res = await fetch(BACKEND_URL + '/api/google-fit/steps', {
                    headers: { Authorization: 'Bearer ' + token }
                });
                if (res.ok) {
                    const data = await res.json();
                    AppState.currentSteps = data.steps || 0;
                    updateStepsDisplay();
                } else if (res.status === 404) {
                    AppState.googleFitConnected = false;
                    updateGoogleFitUI();
                } else if (res.status === 401) {
                    AppState.googleFitConnected = false;
                    updateGoogleFitUI();
                    showGoogleFitMessage('Verbindung abgelaufen. Bitte erneut verbinden.', true);
                }
            } catch (err) {
                console.error('loadSteps:', err);
            }
        }

        function updateStepsDisplay() {
            const stepsEl = document.getElementById('current-steps');
            if (stepsEl) {
                stepsEl.textContent = AppState.currentSteps > 0 ? AppState.currentSteps.toLocaleString('de-DE') : '-';
            }
        }

        function showGoogleFitMessage(text, isError) {
            const msg = document.getElementById('google-fit-message');
            if (!msg) return;
            msg.textContent = text;
            msg.classList.remove('hidden', 'error', 'success');
            msg.classList.add(isError ? 'error' : 'success');
            setTimeout(() => {
                msg.classList.add('hidden');
            }, 5000);
        }

        // Initialize App
        function initApp() {
            loadFromStorage();
            setupEventListeners();
            if (getAuthToken()) {
                fetchUserData().then(async () => {
                    syncAppStateToProfileForm();
                    await checkGoogleFitStatus();
                    updateStepsDisplay();
                    renderGoals(); updateWaterDisplay(); updateBMI(); updateDailyInputs(); renderSchedule(); renderMySupplements();
                });
            }
            updateAuthUI();
            syncAppStateToProfileForm();
            checkGoogleFitStatus();
            updateStepsDisplay();
            renderSupplements();
            renderMySupplements();
            renderSchedule();
            renderGoals();
            updateWaterDisplay();
            updateTimerDisplay();
            updateBMI();
            updateDailyInputs();
            showDailyTip();
            
            // Pr√ºfe Google Fit Callback
            const urlParams = new URLSearchParams(window.location.search);
            const googleFitStatus = urlParams.get('google-fit');
            if (googleFitStatus === 'connected') {
                AppState.googleFitConnected = true;
                updateGoogleFitUI();
                loadSteps();
                showNotification('‚úÖ Google Fit erfolgreich verbunden!');
                // URL bereinigen
                window.history.replaceState({}, '', window.location.pathname);
            } else if (googleFitStatus === 'error') {
                showNotification('‚ùå Google Fit Verbindung fehlgeschlagen.');
                window.history.replaceState({}, '', window.location.pathname);
            }

            // Show loading screen for 2 seconds
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.bottom-nav').classList.add('loaded');
                showScreen('home');
                updateNavigation('home');
            }, 2000);

            // Automatisches Laden der Schrittzahl alle 5 Minuten
            setInterval(() => {
                if (AppState.googleFitConnected && getAuthToken()) {
                    loadSteps();
                }
            }, 5 * 60 * 1000);

            // Setup service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                        
                        // Request notification permission
                        if ('Notification' in window && Notification.permission === 'default') {
                            Notification.requestPermission().then(permission => {
                                console.log('Notification permission:', permission);
                            });
                        }
                        
                        // Register for background sync
                        if ('sync' in window.ServiceWorkerRegistration.prototype) {
                            registration.sync.register('background-sync');
                        }
                        
                        // Register for periodic background sync (timer notifications)
                        if ('periodicSync' in window.ServiceWorkerRegistration.prototype) {
                            registration.periodicSync.register('timer-check', {
                                minInterval: 60000 // Check every minute
                            });
                        }
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }

            // Enhanced PWA installation prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show custom install button
                const installButton = document.createElement('button');
                installButton.textContent = 'üì± App installieren';
                installButton.className = 'btn-primary install-prompt';
                installButton.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    animation: bounce 2s infinite;
                `;
                
                installButton.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                        installButton.remove();
                    });
                });
                
                document.body.appendChild(installButton);
                
                // Also show existing install button if present
                const existingInstallBtn = document.getElementById('install-app');
                if (existingInstallBtn) {
                    existingInstallBtn.classList.remove('hidden');
                }
                
                // Remove button after 10 seconds if not clicked
                setTimeout(() => {
                    if (installButton.parentNode) {
                        installButton.remove();
                    }
                }, 10000);
            });

            // Install button handler (deferredPrompt already declared above)
            document.getElementById('install-app').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    if (outcome === 'accepted') {
                        document.getElementById('install-app').classList.add('hidden');
                    }
                }
            });
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const screen = e.currentTarget.dataset.screen;
                    showScreen(screen);
                    updateNavigation(screen);
                });
            });

            // Water tracking
            document.querySelectorAll('.btn-water').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const amount = parseInt(e.target.dataset.amount);
                    addWater(amount);
                });
            });

            // Timer
            document.getElementById('timer-start').addEventListener('click', startTimer);
            document.getElementById('timer-pause').addEventListener('click', pauseTimer);
            document.getElementById('timer-reset').addEventListener('click', resetTimer);

            // Supplements filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    filterSupplements(filter);
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // Progress tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    showProgressTab(tab);
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // Daily progress inputs
            document.getElementById('energy-level').addEventListener('input', updateSliderValue);
            document.getElementById('sleep-quality').addEventListener('input', updateSliderValue);
            document.getElementById('mood-level').addEventListener('input', updateSliderValue);
            document.getElementById('sport-level').addEventListener('input', updateSliderValue);

            // Profile inputs
            document.getElementById('user-height').addEventListener('input', updateBMI);
            document.getElementById('user-weight').addEventListener('input', updateBMI);
            document.getElementById('user-name').addEventListener('input', saveUserData);
            document.getElementById('user-age').addEventListener('input', saveUserData);

            // Auth
            document.getElementById('auth-login').addEventListener('click', doLogin);
            document.getElementById('auth-register').addEventListener('click', doRegister);
            document.getElementById('auth-logout').addEventListener('click', doLogout);

            // Google Fit
            document.getElementById('google-fit-connect').addEventListener('click', connectGoogleFit);
            document.getElementById('google-fit-disconnect').addEventListener('click', disconnectGoogleFit);
            document.getElementById('google-fit-refresh').addEventListener('click', loadSteps);

            // Settings
            document.getElementById('notifications-enabled').addEventListener('change', toggleNotifications);
            document.getElementById('export-data').addEventListener('click', exportData);

            // Schedule editing
            document.getElementById('edit-schedule').addEventListener('click', toggleScheduleEditMode);
            document.getElementById('add-schedule-item').addEventListener('click', addScheduleItem);
            document.getElementById('save-schedule').addEventListener('click', saveSchedule);
            document.getElementById('reset-schedule').addEventListener('click', resetSchedule);

            // Health tips navigation
            document.getElementById('daily-tip-btn').addEventListener('click', showTodaysTip);
            document.getElementById('random-tip').addEventListener('click', showRandomTip);

            // Supplements
            document.getElementById('add-custom-supplement').addEventListener('click', addCustomSupplement);
        }

        // Screen Management
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
                screen.classList.add('hidden');
            });
            
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('active');
                AppState.currentScreen = screenName;
            }
        }

        function updateNavigation(activeScreen) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-screen="${activeScreen}"]`).classList.add('active');
        }

        // Water Tracking
        function addWater(amount) {
            AppState.waterIntake += amount;
            if (AppState.waterIntake > AppState.waterTarget) {
                AppState.waterIntake = AppState.waterTarget;
            }
            updateWaterDisplay();
            saveToStorage();
            
            // Check if goal reached
            if (AppState.waterIntake >= AppState.waterTarget) {
                showNotification('üéâ Wasserziel erreicht! Gro√üartig!');
            }
        }

        function updateWaterDisplay() {
            document.getElementById('water-current').textContent = AppState.waterIntake;
            document.getElementById('water-target').textContent = AppState.waterTarget;
            
            const percentage = (AppState.waterIntake / AppState.waterTarget) * 100;
            document.getElementById('water-progress').style.width = `${percentage}%`;
        }

        // Timer Functions
        function startTimer() {
            if (!AppState.timerRunning) {
                AppState.timerRunning = true;
                AppState.timerStartTime = Date.now();
                AppState.timerInterval = setInterval(() => {
                    AppState.timerTime--;
                    updateTimerDisplay();
                    
                    if (AppState.timerTime <= 0) {
                        pauseTimer();
                        showNotification('‚è∞ 90-Minuten Timer beendet! Zeit f√ºr eine Pause.');
                        
                        // Send browser notification even when app is in background
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('LifeOptima Timer', {
                                body: '90 Minuten sind vorbei! Zeit f√ºr eine Pause.',
                                icon: './icon-192x192.png',
                                tag: 'timer-complete',
                                requireInteraction: true,
                                vibrate: [200, 100, 200]
                            });
                        }
                        
                        AppState.timerTime = 90 * 60;
                        updateTimerDisplay();
                    }
                }, 1000);
                
                document.getElementById('timer-start').classList.add('hidden');
                document.getElementById('timer-pause').classList.remove('hidden');
                
                // Store timer data for service worker
                localStorage.setItem('timerData', JSON.stringify({
                    startTime: AppState.timerStartTime,
                    duration: 90 * 60,
                    running: true
                }));
            }
        }

        function pauseTimer() {
            AppState.timerRunning = false;
            clearInterval(AppState.timerInterval);
            document.getElementById('timer-start').classList.remove('hidden');
            document.getElementById('timer-pause').classList.add('hidden');
            
            // Update timer data in localStorage
            localStorage.setItem('timerData', JSON.stringify({
                startTime: AppState.timerStartTime,
                duration: 90 * 60,
                running: false,
                remainingTime: AppState.timerTime
            }));
        }

        function resetTimer() {
            pauseTimer();
            AppState.timerTime = 90 * 60;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(AppState.timerTime / 60);
            const seconds = AppState.timerTime % 60;
            document.getElementById('timer-time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Schedule
        function renderSchedule() {
            const container = document.getElementById('schedule-timeline');
            const today = new Date().toLocaleDateString('de-DE', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('schedule-date').textContent = today;
            
            const scheduleData = AppState.customSchedule || SCHEDULE_DATA;
            
            if (AppState.scheduleEditMode) {
                container.innerHTML = scheduleData.map((item, index) => `
                    <div class="schedule-item ${item.focus ? 'focus-phase' : ''} edit-mode">
                        <div class="schedule-edit-controls">
                            <input type="time" class="edit-time" value="${item.time}" data-index="${index}">
                            <button class="btn-delete" onclick="deleteScheduleItem(${index})">üóëÔ∏è</button>
                        </div>
                        <div class="schedule-edit-content">
                            <input type="text" class="edit-activity" value="${item.activity}" data-index="${index}" placeholder="Aktivit√§t">
                            <textarea class="edit-description" data-index="${index}" placeholder="Beschreibung">${item.description}</textarea>
                            <div class="schedule-options">
                                <label>
                                    <input type="checkbox" class="edit-focus" data-index="${index}" ${item.focus ? 'checked' : ''}>
                                    Fokusphase
                                </label>
                                <label>
                                    <input type="checkbox" class="edit-notification" data-index="${index}" ${AppState.scheduleNotifications[`${item.time}-${item.activity}`] ? 'checked' : ''}>
                                    Benachrichtigung
                                </label>
                                <label>
                                    <input type="checkbox" class="edit-repeat" data-index="${index}" ${item.repeat ? 'checked' : ''}>
                                    T√§glich wiederholen
                                </label>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = scheduleData.map((item, index) => `
                    <div class="schedule-item ${item.focus ? 'focus-phase' : ''}">
                        <div class="schedule-time">${item.time}</div>
                        <div class="schedule-activity">
                            <h4>${item.activity}</h4>
                            <p>${item.description}</p>
                            ${AppState.scheduleNotifications[`${item.time}-${item.activity}`] 
                                ? '<div class="notification-indicator">üîî Benachrichtigung aktiv</div>' 
                                : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Setup notifications for current schedule
            if (!AppState.scheduleEditMode) {
                setupScheduleNotifications();
            }
        }

        // Supplements
        function renderSupplements() {
            AppState.supplements = SUPPLEMENTS_DATA;
            filterSupplements('all');
        }

        function filterSupplements(category) {
            let filtered;
            
            if (category === 'all') {
                filtered = AppState.supplements;
            } else if (category.startsWith('priority-')) {
                const priority = parseInt(category.replace('priority-', ''));
                filtered = AppState.supplements.filter(s => s.priority === priority);
            } else {
                filtered = AppState.supplements.filter(s => s.category === category);
            }
            
            // Sort by priority (critical first)
            filtered.sort((a, b) => a.priority - b.priority);
            
            const container = document.getElementById('supplements-list');
            container.innerHTML = filtered.map(supplement => `
                <div class="supplement-card priority-${supplement.priority}">
                    <div class="supplement-header">
                        <div class="supplement-name">${supplement.name}</div>
                        <div class="supplement-category">${getCategoryName(supplement.category)}</div>
                    </div>
                    <div class="supplement-importance">${supplement.importance}</div>
                    <div class="supplement-description">${supplement.description}</div>
                    <div class="supplement-dosage"><strong>Dosierung:</strong> ${supplement.dosage}</div>
                    <div class="supplement-evidence"><strong>Evidenz:</strong> ${supplement.evidence}</div>
                    <div class="supplement-besttime"><strong>Beste Einnahmezeit:</strong> ${supplement.bestTime || '-'}</div>
                    <div class="supplement-actions">
                        <button class="btn-add ${AppState.mySupplements.includes(supplement.name) ? 'added' : ''}" 
                                onclick="toggleSupplement('${supplement.name}')">
                            ${AppState.mySupplements.includes(supplement.name) ? 'Entfernen' : 'Hinzuf√ºgen'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getCategoryName(category) {
            const names = {
                'cognitive': 'Kognition',
                'performance': 'Performance',
                'recovery': 'Recovery'
            };
            return names[category] || category;
        }

        function toggleSupplement(name) {
            const index = AppState.mySupplements.indexOf(name);
            if (index > -1) {
                AppState.mySupplements.splice(index, 1);
            } else {
                AppState.mySupplements.push(name);
            }
            saveToStorage();
            filterSupplements(document.querySelector('.filter-btn.active').dataset.filter);
            renderMySupplements();
        }

        function addCustomSupplement() {
            const name = prompt('Name des Supplements:');
            if (!name) return;
            
            const dosage = prompt('Dosierung (z.B. "500mg t√§glich"):');
            if (!dosage) return;
            
            const customSupplement = {
                name: name,
                dosage: dosage,
                custom: true
            };
            
            // Add to custom supplements list
            if (!AppState.customSupplements) {
                AppState.customSupplements = [];
            }
            AppState.customSupplements.push(customSupplement);
            
            // Add to my supplements
            AppState.mySupplements.push(name);
            
            saveToStorage();
            renderMySupplements();
            showNotification('‚úÖ Eigenes Supplement hinzugef√ºgt!');
        }

        function renderMySupplements() {
            const container = document.getElementById('my-supplements-list');
            
            if (AppState.mySupplements.length === 0) {
                container.innerHTML = '<p class="empty-supplements">Noch keine Supplements hinzugef√ºgt. W√§hle unten aus der Liste aus.</p>';
                return;
            }
            
            const mySupplementsData = [];
            
            // Add supplements from main list
            AppState.mySupplements.forEach(name => {
                const supplement = SUPPLEMENTS_DATA.find(s => s.name === name);
                if (supplement) {
                    mySupplementsData.push(supplement);
                }
            });
            
            // Add custom supplements
            if (AppState.customSupplements) {
                AppState.customSupplements.forEach(custom => {
                    if (AppState.mySupplements.includes(custom.name)) {
                        mySupplementsData.push(custom);
                    }
                });
            }
            
            container.innerHTML = mySupplementsData.map(supplement => {
                // Benachrichtigungsstatus pr√ºfen
                const notifKey = `supplement-${supplement.name}`;
                const notif = AppState.supplementNotifications && AppState.supplementNotifications[notifKey];
                let notifText = '';
                if (notif) {
                    notifText = `<div class='notification-indicator'>üîî Benachrichtigung um <strong>${notif.time} Uhr${notif.repeat ? ' (t√§glich)' : ''}</strong></div>`;
                }
                return `
                    <div class="my-supplement-item">
                        <div class="my-supplement-info">
                            <div class="my-supplement-name">${supplement.name}</div>
                            <div class="my-supplement-dosage">${supplement.dosage || ''}</div>
                            ${notifText}
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="btn-remove" onclick="removeMySupplement('${supplement.name}')">Entfernen</button>
                            <button class="btn-secondary" onclick="setSupplementNotification('${supplement.name}')">Benachrichtigung ${notif ? '√§ndern' : 'einstellen'}</button>
                            ${notif ? `<button class='btn-remove' onclick="removeSupplementNotification('${supplement.name}')">üîï</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeMySupplement(name) {
            const index = AppState.mySupplements.indexOf(name);
            if (index > -1) {
                AppState.mySupplements.splice(index, 1);
            }
            
            // Remove from custom supplements if it's custom
            if (AppState.customSupplements) {
                AppState.customSupplements = AppState.customSupplements.filter(s => s.name !== name);
            }
            
            saveToStorage();
            renderMySupplements();
            filterSupplements(document.querySelector('.filter-btn.active').dataset.filter);
            showNotification('‚ùå Supplement entfernt');
        }

        // Progress Tracking
        function showProgressTab(tab) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            
            if (tab === 'weekly') {
                renderWeeklyStats();
            } else if (tab === 'gesamt') {
                renderGesamtOverview();
            }
        }

        function getValueColor(val) {
            if (val == null || val === '‚Äì' || val === '') return 'var(--neutral-500)';
            const n = parseInt(val, 10);
            if (isNaN(n) || n < 1 || n > 10) return 'var(--neutral-500)';
            const t = (n - 1) / 9;
            const r = Math.round(220 - t * 198);
            const g = Math.round(38 + t * 125);
            const b = Math.round(38 + t * 36);
            return `rgb(${r},${g},${b})`;
        }

        function updateSliderValue(e) {
            const value = e.target.value;
            const id = e.target.id;
            const valueSpan = document.getElementById(id.replace('-level', '-value').replace('-quality', '-value'));
            if (valueSpan) {
                valueSpan.textContent = value;
                valueSpan.style.backgroundColor = getValueColor(value);
                valueSpan.style.color = parseInt(value) <= 4 ? '#fff' : '#000';
            }
            if (dailyProgressSaveTimeout) clearTimeout(dailyProgressSaveTimeout);
            dailyProgressSaveTimeout = setTimeout(() => saveDailyProgress(false), 300);
        }

        function saveDailyProgress(showToast = true) {
            const today = new Date().toISOString().split('T')[0];
            AppState.dailyData = {
                energy: parseInt(document.getElementById('energy-level').value),
                sleep: parseInt(document.getElementById('sleep-quality').value),
                mood: parseInt(document.getElementById('mood-level').value),
                sport: parseInt(document.getElementById('sport-level').value),
                date: today
            };
            
            // History: genau ein Eintrag pro Tag (Update bestehendes oder neu hinzuf√ºgen)
            const history = JSON.parse(localStorage.getItem('dailyHistory') || '[]');
            const withoutToday = history.filter(d => d.date !== today);
            withoutToday.push(AppState.dailyData);
            withoutToday.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
            localStorage.setItem('dailyHistory', JSON.stringify(withoutToday));
            
            saveToStorage();
            if (showToast) showNotification('‚úÖ T√§glicher Fortschritt gespeichert!');
        }

        function updateDailyInputs() {
            const d = AppState.dailyData || {};
            ['sport','energy','sleep','mood'].forEach(key => {
                const el = document.getElementById(key === 'sleep' ? 'sleep-quality' : `${key}-level`);
                const valEl = document.getElementById(key === 'sleep' ? 'sleep-value' : `${key}-value`);
                const v = d[key] ?? 5;
                if (el) el.value = v;
                if (valEl) {
                    valEl.textContent = v;
                    valEl.style.backgroundColor = getValueColor(v);
                    valEl.style.color = v <= 4 ? '#fff' : '#000';
                }
            });
        }

        function getWeekDates() {
            const dates = [];
            const d = new Date();
            for (let i = 6; i >= 0; i--) {
                const x = new Date(d);
                x.setDate(x.getDate() - i);
                dates.push(x.toISOString().split('T')[0]);
            }
            return dates;
        }

        function renderWeeklyStats() {
            const history = JSON.parse(localStorage.getItem('dailyHistory') || '[]');
            const weekDates = getWeekDates();
            const byDate = {};
            history.forEach(h => { if (h.date) byDate[h.date] = h; });
            const metrics = [
                { key: 'sport', label: 'Sport' },
                { key: 'energy', label: 'Energie' },
                { key: 'sleep', label: 'Schlaf' },
                { key: 'mood', label: 'Stimmung' }
            ];
            const weekData = weekDates
                .map(date => ({ date, ...(byDate[date] || {}) }))
                .filter(d => metrics.some(m => d[m.key] !== undefined));
            
            const container = document.getElementById('weekly-charts');
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            const cell = (val) => {
                if (val == null || val === '‚Äì') return '<td class="no-data">‚Äì</td>';
                const c = getValueColor(val);
                return `<td><span class="value-cell" style="background:${c};color:${val<=4?'#fff':'#000'}">${val}</span></td>`;
            };
            const dayRows = weekDates.map(date => {
                const d = byDate[date] || {};
                const day = new Date(date + 'T12:00:00');
                const name = dayNames[day.getDay()];
                const short = date.slice(5);
                const metricCells = metrics.map(m => cell(d[m.key])).join('');
                return `<tr><td>${name} ${short}</td>${metricCells}</tr>`;
            }).join('');
            
            const avgByMetric = {};
            metrics.forEach(m => {
                const len = weekData.filter(d => d[m.key] != null).length;
                avgByMetric[m.key] = len
                    ? (weekData.reduce((s, d) => s + (d[m.key] || 0), 0) / len).toFixed(1)
                    : '‚Äì';
            });
            const headerCells = metrics.map(m => `<th>${m.label}</th>`).join('');
            const statRows = metrics.map(m =>
                `<div class="stat-item"><span>${m.label}:</span><span class="value-cell" style="background:${getValueColor(avgByMetric[m.key])}">${avgByMetric[m.key]}/10</span></div>`
            ).join('');
            
            container.innerHTML = `
                <div class="weekly-summary">
                    <h4>Letzte 7 Tage</h4>
                    <table class="weekly-table">
                        <thead><tr><th>Tag</th>${headerCells}</tr></thead>
                        <tbody>${dayRows}</tbody>
                    </table>
                    <h4>Durchschnitt (nur Tage mit Eintrag)</h4>
                    <div class="stat-grid">${statRows}</div>
                </div>
            `;
        }

        let progressCalendarMonth = new Date().getMonth();
        let progressCalendarYear = new Date().getFullYear();

        function renderGesamtOverview() {
            const history = JSON.parse(localStorage.getItem('dailyHistory') || '[]');
            const container = document.getElementById('gesamt-content');
            const byDate = {};
            history.forEach(h => { if (h.date) byDate[h.date] = h; });
            const sorted = Object.keys(byDate).sort();
            const daysWithData = sorted.length;
            
            const metrics = [
                { key: 'sport', label: 'Sport' },
                { key: 'energy', label: 'Energie' },
                { key: 'sleep', label: 'Schlaf' },
                { key: 'mood', label: 'Stimmung' }
            ];
            
            const avg = (key) => {
                const arr = sorted.map(d => byDate[d]).filter(x => x[key] != null);
                return arr.length ? (arr.reduce((s, d) => s + d[key], 0) / arr.length).toFixed(1) : '‚Äì';
            };
            const avgEnergy = avg('energy');
            const avgSleep = avg('sleep');
            const avgMood = avg('mood');
            const avgSport = avg('sport');
            const first = sorted[0] || '‚Äì';
            const last = sorted[sorted.length - 1] || '‚Äì';
            
            const insights = [];
            if (parseFloat(avgEnergy) >= 7) insights.push({ icon: 'üî•', text: 'Hohes Energielevel ‚Äì Gewohnheiten beibehalten.' });
            else if (parseFloat(avgEnergy) < 5) insights.push({ icon: '‚ö†Ô∏è', text: 'Niedrige Energie ‚Äì Schlaf, Ern√§hrung und Stress pr√ºfen.' });
            if (parseFloat(avgSleep) < 5) insights.push({ icon: 'üò¥', text: 'Schlafqualit√§t verbessern ‚Äì z.B. Magnesium, Bildschirm reduzieren.' });
            if (parseFloat(avgMood) >= 7) insights.push({ icon: 'üòä', text: 'Stabile Stimmung ‚Äì gut unterwegs!' });
            else if (parseFloat(avgMood) < 5) insights.push({ icon: 'üí≠', text: 'Stimmung niedrig ‚Äì Bewegung und soziale Kontakte helfen oft.' });
            if (parseFloat(avgSport) < 5 && daysWithData > 0) insights.push({ icon: 'üèÉ', text: 'Mehr Sport k√∂nnte Energie und Stimmung steigern.' });
            
            const monthNames = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            const dayNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];
            const year = progressCalendarYear;
            const month = progressCalendarMonth;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startOffset = (firstDay.getDay() + 6) % 7;
            const daysInMonth = lastDay.getDate();
            const buildCalendarForMetric = (metricKey, metricLabel) => {
                let calHtml = `<div class="progress-calendar"><div class="calendar-metric-title">${metricLabel}</div>`;
                calHtml += '<div class="calendar-grid"><div class="cal-row cal-header">' + dayNames.map(d => `<span>${d}</span>`).join('') + '</div>';
                let day = 1;
                let rows = '';
                for (let w = 0; w < 6; w++) {
                    let cells = '';
                    for (let d = 0; d < 7; d++) {
                        const idx = w * 7 + d;
                        if (idx < startOffset || day > daysInMonth) {
                            cells += '<span class="cal-cell cal-empty"></span>';
                        } else {
                            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                            const data = byDate[dateStr];
                            const val = data ? data[metricKey] : null;
                            const bg = val != null ? getValueColor(val) : 'var(--neutral-200)';
                            const fg = val != null && val <= 4 ? '#fff' : (val != null ? '#000' : 'var(--neutral-500)');
                            cells += `<span class="cal-cell" style="background:${bg};color:${fg}" title="${metricLabel} ${dateStr}${val != null ? ': ' + val + '/10' : ''}">${day}</span>`;
                            day++;
                        }
                    }
                    rows += '<div class="cal-row">' + cells + '</div>';
                }
                calHtml += rows + '</div></div>';
                return calHtml;
            };
            
            const statItem = (label, val) => {
                const c = getValueColor(val);
                return `<div class="stat-item"><span>${label}:</span><span class="value-cell" style="background:${c};color:${val!=='‚Äì'&&parseFloat(val)<=4?'#fff':'inherit'}">${val}/10</span></div>`;
            };
            
            container.innerHTML = `
                <div class="calendar-header">
                    <button type="button" class="cal-nav" data-dir="-1">‚Üê</button>
                    <span>${monthNames[month]} ${year}</span>
                    <button type="button" class="cal-nav" data-dir="1">‚Üí</button>
                </div>
                <div class="calendar-multi">
                    ${metrics.map(m => buildCalendarForMetric(m.key, m.label)).join('')}
                </div>
                <p class="cal-legend"><span style="background:rgb(220,38,38)"></span> 1 ¬∑¬∑¬∑¬∑¬∑ <span style="background:rgb(22,163,74)"></span> 10</p>
                <div class="gesamt-stats">
                    <div class="stat-card"><span class="stat-value">${daysWithData}</span><span class="stat-label">Tage erfasst</span></div>
                    <div class="stat-card"><span class="stat-value">${first}</span><span class="stat-label">Erster Eintrag</span></div>
                    <div class="stat-card"><span class="stat-value">${last}</span><span class="stat-label">Letzter Eintrag</span></div>
                </div>
                <h4>Gesamtdurchschnitt</h4>
                <div class="stat-grid">
                    ${statItem('Sport', avgSport)}
                    ${statItem('Energie', avgEnergy)}
                    ${statItem('Schlaf', avgSleep)}
                    ${statItem('Stimmung', avgMood)}
                </div>
                ${insights.length ? '<h4>Insights</h4><ul class="insight-list">' + insights.map(i => `<li>${i.icon} ${i.text}</li>`).join('') + '</ul>' : ''}
            `;
            container.querySelectorAll('.cal-nav').forEach(btn => {
                btn.addEventListener('click', () => {
                    const d = parseInt(btn.dataset.dir, 10);
                    progressCalendarMonth += d;
                    if (progressCalendarMonth > 11) { progressCalendarMonth = 0; progressCalendarYear++; }
                    if (progressCalendarMonth < 0) { progressCalendarMonth = 11; progressCalendarYear--; }
                    renderGesamtOverview();
                });
            });
        }

        // Profile
        function renderGoals() {
            const container = document.getElementById('goals-list');
            container.innerHTML = GOALS_DATA.map(goal => `
                <div class="goal-card ${AppState.userData.goals.includes(goal.id) ? 'active' : ''}" 
                     onclick="toggleGoal('${goal.id}')">
                    <div class="goal-icon">${goal.icon}</div>
                    <div class="goal-title">${goal.title}</div>
                </div>
            `).join('');
        }

        function toggleGoal(goalId) {
            const index = AppState.userData.goals.indexOf(goalId);
            if (index > -1) {
                AppState.userData.goals.splice(index, 1);
            } else {
                AppState.userData.goals.push(goalId);
            }
            saveToStorage();
            renderGoals();
        }

        function syncAppStateToProfileForm() {
            const u = AppState.userData || {};
            const nameEl = document.getElementById('user-name');
            const ageEl = document.getElementById('user-age');
            const heightEl = document.getElementById('user-height');
            const weightEl = document.getElementById('user-weight');
            const notifEl = document.getElementById('notifications-enabled');
            if (nameEl) nameEl.value = u.name ?? '';
            if (ageEl) ageEl.value = u.age ?? 25;
            if (heightEl) heightEl.value = u.height ?? 175;
            if (weightEl) weightEl.value = u.weight ?? 70;
            if (notifEl) notifEl.checked = !!AppState.notifications;
        }

        function updateBMI() {
            const height = parseFloat(document.getElementById('user-height').value);
            const weight = parseFloat(document.getElementById('user-weight').value);
            
            if (height && weight) {
                const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
                document.getElementById('bmi-value').textContent = bmi;
                
                AppState.userData.height = height;
                AppState.userData.weight = weight;
                saveToStorage();
            }
        }

        function saveUserData() {
            AppState.userData.name = document.getElementById('user-name').value;
            AppState.userData.age = parseInt(document.getElementById('user-age').value);
            saveToStorage();
        }

        // Notifications
        function toggleNotifications() {
            AppState.notifications = document.getElementById('notifications-enabled').checked;
            saveToStorage();
            
            if (AppState.notifications) {
                requestNotificationPermission();
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        }

        function showNotification(message) {
            if (AppState.notifications && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('LifeOptima', {
                    body: message,
                    icon: './icon-192x192.png'
                });
            }
        }

        // Health Tips
        function showDailyTip() {
            // Generate daily tip based on current date for consistency
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            AppState.currentTipIndex = dayOfYear % HEALTH_TIPS.length;
            updateTipDisplay();
        }

        function updateTipDisplay() {
            const tip = HEALTH_TIPS[AppState.currentTipIndex];
            document.getElementById('daily-tip').textContent = tip;
            document.getElementById('tip-current').textContent = AppState.currentTipIndex + 1;
            document.getElementById('tip-total').textContent = HEALTH_TIPS.length;
            
            // Update daily tip badge
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const dailyTipIndex = dayOfYear % HEALTH_TIPS.length;
            const badge = document.getElementById('daily-tip-badge');
            
            if (AppState.currentTipIndex === dailyTipIndex) {
                badge.style.display = 'block';
                badge.textContent = 'üìÖ Tipp des Tages';
                badge.style.background = 'linear-gradient(135deg, var(--secondary-500), var(--secondary-600))';
                badge.style.color = 'white';
            } else {
                badge.style.display = 'block';
                badge.textContent = 'üìñ Durchsuchen';
                badge.style.background = 'var(--glass-bg)';
                badge.style.color = 'var(--neutral-700)';
            }
            
            saveToStorage();
        }





        function showTodaysTip() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            AppState.currentTipIndex = dayOfYear % HEALTH_TIPS.length;
            updateTipDisplay();
        }

        function showRandomTip() {
            AppState.currentTipIndex = Math.floor(Math.random() * HEALTH_TIPS.length);
            updateTipDisplay();
        }

        // Data Management
        function saveToStorage() {
            localStorage.setItem('lifeOptima', JSON.stringify(AppState));
            if (getAuthToken()) syncToServerDebounced();
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('lifeOptima');
            const today = new Date().toISOString().split('T')[0];
            const history = JSON.parse(localStorage.getItem('dailyHistory') || '[]');
            const todayEntry = history.find(d => d.date === today);

            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(AppState, data);
                
                if (!AppState.dailyData || !AppState.dailyData.date || AppState.dailyData.date !== today) {
                    AppState.waterIntake = 0;
                    if (todayEntry) {
                        AppState.dailyData = { energy: todayEntry.energy ?? 5, sleep: todayEntry.sleep ?? 5, mood: todayEntry.mood ?? 5, sport: todayEntry.sport ?? 5, date: today };
                    } else {
                        AppState.dailyData = { energy: 5, sleep: 5, mood: 5, sport: 5, date: today };
                    }
                } else if (todayEntry) {
                    AppState.dailyData = { ...AppState.dailyData, ...todayEntry, date: today };
                }
                // Check if tip should be reset for new day
                const lastTipDate = localStorage.getItem('lifeOptima_tipDate');
                if (lastTipDate !== today) {
                    // New day - set tip based on date, but don't override manual navigation
                    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                    AppState.currentTipIndex = dayOfYear % HEALTH_TIPS.length;
                    localStorage.setItem('lifeOptima_tipDate', today);
                }
            } else {
                // First time - set daily tip
                const today = new Date().toISOString().split('T')[0];
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                AppState.currentTipIndex = dayOfYear % HEALTH_TIPS.length;
                localStorage.setItem('lifeOptima_tipDate', today);
            }
        }

        function exportData() {
            const history = JSON.parse(localStorage.getItem('dailyHistory') || '[]');
            const exportData = {
                appState: AppState,
                dailyHistory: history,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifeoptima-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('üì¶ Daten erfolgreich exportiert!');
        }

        // Schedule Functions
        function toggleScheduleEditMode() {
            AppState.scheduleEditMode = !AppState.scheduleEditMode;
            
            const editBtn = document.getElementById('edit-schedule');
            const addBtn = document.getElementById('add-schedule-item');
            const saveBtn = document.getElementById('save-schedule');
            const resetBtn = document.getElementById('reset-schedule');
            
            if (AppState.scheduleEditMode) {
                editBtn.textContent = '‚ùå Abbrechen';
                addBtn.classList.remove('hidden');
                saveBtn.classList.remove('hidden');
                resetBtn.classList.remove('hidden');
            } else {
                editBtn.textContent = '‚úèÔ∏è Bearbeiten';
                addBtn.classList.add('hidden');
                saveBtn.classList.add('hidden');
                resetBtn.classList.add('hidden');
            }
            
            renderSchedule();
        }

        function addScheduleItem() {
            const scheduleData = AppState.customSchedule || [...SCHEDULE_DATA];
            const newItem = {
                time: '12:00',
                activity: 'Neue Aktivit√§t',
                description: 'Beschreibung hinzuf√ºgen',
                phase: 'custom',
                focus: false
            };
            
            scheduleData.push(newItem);
            scheduleData.sort((a, b) => a.time.localeCompare(b.time));
            AppState.customSchedule = scheduleData;
            renderSchedule();
        }

        function deleteScheduleItem(index) {
            if (confirm('Diesen Eintrag wirklich l√∂schen?')) {
                const scheduleData = AppState.customSchedule || [...SCHEDULE_DATA];
                scheduleData.splice(index, 1);
                AppState.customSchedule = scheduleData;
                renderSchedule();
            }
        }

        // Hilfsfunktion: Push-Subscription holen
        async function getPushSubscription() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) return null;
            const reg = await navigator.serviceWorker.getRegistration('./sw-push.js');
            if (!reg) return null;
            return await reg.pushManager.getSubscription();
        }

        // Schedule Functions (Erg√§nzung in saveSchedule)
        async function saveSchedule() {
            const scheduleData = AppState.customSchedule || [...SCHEDULE_DATA];
            const updatedSchedule = [];

            document.querySelectorAll('.schedule-item.edit-mode').forEach((item, index) => {
                const time = item.querySelector('.edit-time').value;
                const activity = item.querySelector('.edit-activity').value;
                const description = item.querySelector('.edit-description').value;
                const focus = item.querySelector('.edit-focus').checked;
                const notification = item.querySelector('.edit-notification').checked;
                const repeat = item.querySelector('.edit-repeat')?.checked || false;

                const scheduleItem = {
                    time,
                    activity,
                    description,
                    phase: focus ? 'focus' : 'custom',
                    focus,
                    repeat
                };

                updatedSchedule.push(scheduleItem);

                // Handle notifications
                const notificationKey = `${time}-${activity}`;
                if (notification) {
                    AppState.scheduleNotifications[notificationKey] = true;
                    // Push-Benachrichtigung planen (nur wenn Push aktiviert)
                    if (pushEnabled) {
                        getPushSubscription().then(pushSub => {
                            if (pushSub) {
                                fetch(BACKEND_URL + '/schedule-push', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        subscription: pushSub,
                                        time: time.substring(0,5), // HH:MM
                                        title: 'LifeOptima Tagesplan',
                                        message: `${activity} - Es ist ${time} Uhr!`,
                                        activity,
                                        repeat
                                    })
                                }).catch(error => {
                                    console.error('Push-Backend Fehler:', error);
                                });
                            }
                        });
                    }
                } else {
                    delete AppState.scheduleNotifications[notificationKey];
                    // Push-Benachrichtigung im Backend l√∂schen
                    if (pushEnabled) {
                        getPushSubscription().then(pushSub => {
                            if (pushSub) {
                                fetch(BACKEND_URL + '/delete-scheduled-push', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        subscription: pushSub,
                                        time: time.substring(0,5),
                                        activity
                                    })
                                }).catch(error => {
                                    console.error('Push-Backend Fehler:', error);
                                });
                            }
                        });
                    }
                }
            });

            // Sort by time
            updatedSchedule.sort((a, b) => a.time.localeCompare(b.time));
            AppState.customSchedule = updatedSchedule;

            saveToStorage();
            toggleScheduleEditMode();
            showNotification('üìÖ Tagesplan gespeichert!');
        }

        function resetSchedule() {
            if (confirm('Tagesplan auf Standard zur√ºcksetzen?')) {
                AppState.customSchedule = null;
                AppState.scheduleNotifications = {};
                saveToStorage();
                renderSchedule();
                showNotification('üîÑ Tagesplan zur√ºckgesetzt!');
            }
        }

        function setupScheduleNotifications() {
            if (!AppState.notifications) return;
            
            const now = new Date();
            const scheduleData = AppState.customSchedule || SCHEDULE_DATA;
            
            Object.keys(AppState.scheduleNotifications).forEach(key => {
                const [time, activity] = key.split('-');
                const [hours, minutes] = time.split(':').map(Number);
                
                const scheduledTime = new Date();
                scheduledTime.setHours(hours, minutes, 0, 0);
                
                // If the time is in the past, schedule for tomorrow
                if (scheduledTime <= now) {
                    scheduledTime.setDate(scheduledTime.getDate() + 1);
                }
                
                const timeUntilNotification = scheduledTime.getTime() - now.getTime();
                
                if (timeUntilNotification > 0) {
                    setTimeout(() => {
                        showNotification(`‚è∞ ${activity} - Es ist ${time} Uhr!`);
                    }, timeUntilNotification);
                }
            });
        }

        // === PUSH NOTIFICATIONS SETUP ===
        // BACKEND_URL ist oben im Script definiert

        async function registerPush() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('Push nicht unterst√ºtzt');
                return false;
            }
            try {
                // Service Worker f√ºr Push registrieren
                const reg = await navigator.serviceWorker.register('./sw-push.js');
                console.log('Push Service Worker registriert:', reg);

                // VAPID Public Key holen
                const vapidRes = await fetch(BACKEND_URL + '/vapidPublicKey');
                if (!vapidRes.ok) {
                    console.error('Backend nicht erreichbar:', BACKEND_URL);
                    return false;
                }
                const { publicKey } = await vapidRes.json();
                const convertedKey = urlBase64ToUint8Array(publicKey);

                // Subscription holen/erstellen
                let sub = await reg.pushManager.getSubscription();
                if (!sub) {
                    sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedKey
                    });
                    // An Backend senden
                    const subscribeRes = await fetch(BACKEND_URL + '/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sub)
                    });
                    if (subscribeRes.ok) {
                        console.log('Push Subscription registriert und an Backend gesendet');
                        showNotification('üîî Push-Benachrichtigungen aktiviert!');
                        return true;
                    } else {
                        console.error('Backend-Subscription fehlgeschlagen');
                        return false;
                    }
                } else {
                    console.log('Push Subscription existiert bereits');
                    return true;
                }
            } catch (err) {
                console.error('Push Registrierung fehlgeschlagen:', err);
                // Fallback: Lokale Benachrichtigungen verwenden
                if (Notification.permission === 'granted') {
                    showNotification('‚ö†Ô∏è Push-Backend nicht verf√ºgbar, verwende lokale Benachrichtigungen');
                }
                return false;
            }
        }

        // Hilfsfunktion: VAPID-Key umwandeln
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Testfunktion f√ºr Push (nur zu Testzwecken)
        async function sendTestPush() {
            await fetch(BACKEND_URL + '/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: 'Test', message: 'Das ist eine Test-Push-Nachricht von LifeOptima.' })
            });
        }

        // Registrierung beim App-Start
        let pushEnabled = false;
        registerPush().then(enabled => {
            pushEnabled = enabled;
            console.log('Push-Status:', pushEnabled ? 'Aktiviert' : 'Deaktiviert');
        });

        // Supplement-Benachrichtigung setzen
        async function setSupplementNotification(name) {
            if (!AppState.supplementNotifications) AppState.supplementNotifications = {};
            const time = prompt('Zu welcher Uhrzeit m√∂chtest du an die Einnahme von ' + name + ' erinnert werden? (HH:MM, z.B. 21:00)');
            if (!time || !/^\d{2}:\d{2}$/.test(time)) return alert('Ung√ºltiges Zeitformat. Beispiel: 21:00');
            const repeat = confirm('T√§glich wiederholen?');
            
            if (pushEnabled) {
                const pushSub = await getPushSubscription();
                if (pushSub) {
                    try {
                        // Im Backend planen
                        const response = await fetch(BACKEND_URL + '/schedule-push', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                subscription: pushSub,
                                time,
                                title: 'Supplement-Erinnerung',
                                message: `Zeit f√ºr ${name}!`,
                                activity: name,
                                repeat
                            })
                        });
                        if (!response.ok) {
                            throw new Error('Backend-Fehler');
                        }
                    } catch (error) {
                        console.error('Push-Backend Fehler:', error);
                        showNotification('‚ö†Ô∏è Push-Backend nicht verf√ºgbar, verwende lokale Erinnerung');
                    }
                }
            }
            
            // Immer lokale Erinnerung setzen (Fallback)
            AppState.supplementNotifications[`supplement-${name}`] = { time, repeat };
            saveToStorage();
            renderMySupplements();
            showNotification('üîî Supplement-Erinnerung gespeichert!');
        }

        // Supplement-Benachrichtigung entfernen
        async function removeSupplementNotification(name) {
            if (!AppState.supplementNotifications) AppState.supplementNotifications = {};
            const notif = AppState.supplementNotifications[`supplement-${name}`];
            if (!notif) return;
            
            if (pushEnabled) {
                const pushSub = await getPushSubscription();
                if (pushSub) {
                    try {
                        await fetch(BACKEND_URL + '/delete-scheduled-push', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                subscription: pushSub,
                                time: notif.time,
                                activity: name
                            })
                        });
                    } catch (error) {
                        console.error('Push-Backend Fehler beim L√∂schen:', error);
                    }
                }
            }
            
            delete AppState.supplementNotifications[`supplement-${name}`];
            saveToStorage();
            renderMySupplements();
            showNotification('üîï Supplement-Erinnerung entfernt');
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html> 